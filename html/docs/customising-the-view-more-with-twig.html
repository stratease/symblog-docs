
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic &mdash; symblog - A Symfony2 Tutorial</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="symblog - A Symfony2 Tutorial" href="../index.html" />
    <link rel="next" title="[Part 6] - Testing: Unit and Functional with PHPUnit" href="testing-unit-and-functional-phpunit.html" />
    <link rel="prev" title="[Part 4] - The Comments Model: Adding comments, Doctrine Repositories and Migrations" href="extending-the-model-blog-comments.html" />
<!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href='http://fonts.googleapis.com/css?family=Irish+Grover' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=La+Belle+Aurore' rel='stylesheet' type='text/css'>
<style type="text/css">
    #header {line-height: 1;font-family: Arial, Helvetica, sans-serif;font-size: 12px; width: 100%; height: 100%; color: #000; font-size: 14px; }

    html { background: none; }
    a { text-decoration: none !important; color: #F48A00 !important; font-weight: normal !important }

    h1, h2, h3, h4, h5, h6 { color: #000 }

    #header a:link { font-weight: normal !important; }

    #header { border-bottom: 1px solid #ccc; margin-bottom: 20px; }
    #header .top { border-bottom: 1px solid #ccc; margin-bottom: 10px; }
    #header ul.languages { list-style: none; text-align: right; margin-bottom: 0; display: inline-block; }
    #header .languages li { display: inline }
    #header .languages li a { display: inline-block; padding: 10px 10px 10px 25px; border-right: 1px solid #ccc; background-repeat: no-repeat; background-position: 5px center  }
    #header .en { background-image: url('/_static/images/icons/languages/gb.png'); }
    #header .es { background-image: url('/_static/images/icons/languages/es.png'); }
    #header .fr { background-image: url('/_static/images/icons/languages/fr.png'); }
    #header ul.navigation { list-style: none; text-align: right; margin-bottom: 0; display: inline-block; float: right; }
    #header .navigation li { display: inline }
    #header .navigation li a { display: inline-block; padding: 10px 15px; border-left: 1px solid #ccc; }
    #header h2 { font-family: 'Irish Grover', cursive; font-size: 92px; text-align: center; line-height: 110px; border-bottom: none; margin: 0px; font-weight: normal; }
    #header h2 a { color: #000 !important }
    #header h3 { text-align: center; font-family: 'La Belle Aurore', cursive; font-size: 24px; margin: 0; margin-bottom: 20px; font-weight: normal;  font-weight: normal;}

    div.content { font-size: 0.9em; margin: 10px 20px 20px; }

    .note, .tip, .warning {
        border: 1px solid !important;
        margin: 10px 0px !important;
        padding:15px 10px 15px 70px !important;
        background-repeat: no-repeat !important;
        background-position: 10px center !important;
    }
    .note {
        border-color: #00529B !important;
        background-color: #DBF3FF !important;
        background-image: url('../_static/images/icons/note.png') !important;
    }
    .tip {
        border-color: #4F8A10 !important;
        background-color: #E5F2D0 !important;
        background-image:url('../_static/images/icons/tip.png') !important;
        }
    .warning {
        border-color: #9F6000 !important;
        background-color: #FFF7DB !important;
        background-image: url('../_static/images/icons/warning.png') !important;
    }
</style>

  </head>
  <body>

    <header id="header">
        <div class="top">
            <nav>
                <ul class="languages">
                    <li><a href="http://tutorial.symblog.co.uk" class="en">EN</a></li>
                    <li><a href="http://symblog.site90.net/" class="es">ES</a></li>
                    <li><a href="http://keiruaprod.fr/symblog-fr/" class="fr">FR</a></li>
                </ul>
                <ul class="navigation">
                    <li><a href="/">Home</a></li>
                    <li><a href="http://symblog.co.uk">Demo</a></li>
                    <li><a href="https://github.com/dsyph3r/symblog">Source</a></li>
                </ul>
            </nav>
        </div>

        <hgroup>
            <h2><a href="/">symblog</a></h2>
            <h3><a href="/">creating a blog in Symfony2</a></h3>
        </hgroup>
    </header>

  <div class="topnav">
  
        <p>
        «&#160;&#160;<a href="extending-the-model-blog-comments.html">[Part 4] - The Comments Model: Adding comments,  Doctrine Repositories and Migrations</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="testing-unit-and-functional-phpunit.html">[Part 6] - Testing: Unit and Functional with PHPUnit</a>&#160;&#160;»
        </p>

  </div>
  <div class="content">

    
    
  <div class="section" id="part-5-customising-the-view-twig-extensions-the-sidebar-and-assetic">
<h1>[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic<a class="headerlink" href="#part-5-customising-the-view-twig-extensions-the-sidebar-and-assetic" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This chapter will continue to build on the frontend of symblog. We will tweak
the homepage to display information regarding comments for a blog post along
with addressing SEO by adding the blog title to the URL. We will also begin work
on the sidebar to add 2 common blog components; The Tag Cloud and the Latest
Comments. We will explore the various environments in Symfony2 and learn how to
run symblog in the production environment. The Twig templating engine will be
extended to provide a new filter, and we introduce Assetic to manage the
website asset files. At the end of this chapter you will have integrated
comments into the homepage, have a Tag Cloud and Latest Comments component on the
sidebar and will have used Assetic to manage the asset files. You will also have seen
symblog running in the production environment.</p>
</div>
<div class="section" id="the-homepage-blogs-and-comments">
<h2>The Homepage - Blogs and Comments<a class="headerlink" href="#the-homepage-blogs-and-comments" title="Permalink to this headline">¶</a></h2>
<p>So far the homepage lists the latest blog entries but it doesn&#8217;t give any
information regarding the comments for those blogs. Now that we have the
<tt class="docutils literal"><span class="pre">Comment</span></tt> entity built we can revisit the homepage to provide this information.
As we have set up the link between <tt class="docutils literal"><span class="pre">Blog</span></tt> and <tt class="docutils literal"><span class="pre">Comment</span></tt> entities we know
Doctrine 2 will be able to retrieve the comments for a blog (remember we added a
<tt class="docutils literal"><span class="pre">$comments</span></tt> member to the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity). Let&#8217;s update the homepage view template
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/index.html.twig</span></tt> with
the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/index.html.twig #}

{# .. #}

<span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;meta&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>Comments: {{ blog.comments|length }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Posted by <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.author }}<span class="nt">&lt;/span&gt;</span> at {{ blog.created|date(&#39;h:iA&#39;) }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Tags: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.tags }}<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/footer&gt;</span>

{# .. #}
</pre></div>
</div>
<p>We have used the <tt class="docutils literal"><span class="pre">comments</span></tt> getter to retrieve the blog comments and then passed
the collection through the Twig <tt class="docutils literal"><span class="pre">length</span></tt> filter. If you have a look
at the homepage now via <tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/</span></tt> you will see the
number of comments for each blog being displayed.</p>
<p>As explained above, we already informed Doctrine 2 that the <tt class="docutils literal"><span class="pre">$comments</span></tt> member of the
<tt class="docutils literal"><span class="pre">Blog</span></tt> entity is mapped to the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity. We achieved this in the previous chapter
with the following metadata in the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\OneToMany(targetEntity=&quot;Comment&quot;, mappedBy=&quot;blog&quot;)</span>
<span class="sd"> */</span>
<span class="k">protected</span> <span class="nv">$comments</span><span class="p">;</span>
</pre></div>
</div>
<p>So we know Doctrine 2 is aware of the relationship between blogs and comments, but
how did it populate the <tt class="docutils literal"><span class="pre">$comments</span></tt> member with the related <tt class="docutils literal"><span class="pre">Comment</span></tt>
entities? If you remember back to the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> method we created (shown
below) to get the homepage blogs we made no selection to retrieve the related <tt class="docutils literal"><span class="pre">Comment</span></tt> entities.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Repository/BlogRepository.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getLatestBlogs</span><span class="p">(</span><span class="nv">$limit</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">addOrderBy</span><span class="p">(</span><span class="s1">&#39;b.created&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$limit</span><span class="p">))</span>
        <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$limit</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
              <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>However, Doctrine 2 uses a process called lazy loading where the <tt class="docutils literal"><span class="pre">Comment</span></tt> entities are
retrieved from the database as and when required, in our case when the call to
<tt class="docutils literal"><span class="pre">{{</span> <span class="pre">blog.comments|length</span> <span class="pre">}}</span></tt> is made. We can demonstrate this process using
the developer toolbar. We have already started to explore the basics of the developer
toolbar and it&#8217;s now time to introduce one of its most useful features, the Doctrine 2
profiler. The Doctrine 2 profiler can be accessed by clicking the last icon in
the developer toolbar. The number next to this icon shows the number of queries
executed on the database for the current HTTP request.</p>
<img alt="Developer toolbar - Doctrine 2 icon" class="align-center" src="../_images/doctrine_2_toolbar_icon.jpg" />
<p>If you click the Doctrine 2 icon you will be presented with information
regarding the queries that were executed by Doctrine 2 on the database for the
current HTTP request.</p>
<img alt="Developer toolbar - Doctrine 2 queries" class="align-center" src="../_images/doctrine_2_toolbar_queries.jpg" />
<p>As you can see in the above screen shot, there are a number of queries executed
for a request to the homepage. The second query executed retrieves the blog
entities from the database and is executed as a result of the
<tt class="docutils literal"><span class="pre">getLatestBlogs()</span></tt> method on the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> class. Following this
query you will notice a number of queries that pull comments from the database,
one blog at a time. We can see this because of the <tt class="docutils literal"><span class="pre">WHERE</span> <span class="pre">t0.blog_id</span> <span class="pre">=</span> <span class="pre">?</span></tt> in
each of the queries, where the <tt class="docutils literal"><span class="pre">?</span></tt> is replaced by the Parameter value (the blog
Id) on the following line. Each of these queries are as a result of the calls to
<tt class="docutils literal"><span class="pre">{{</span> <span class="pre">blog.comments</span> <span class="pre">}}</span></tt> in the homepage template. Each time this function is
executed, Doctrine 2 has to lazily load the <tt class="docutils literal"><span class="pre">Comment</span></tt> entities that relate to
the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity.</p>
<p>While lazy loading is very effective at retrieving related entities from the database,
it&#8217;s not always the most efficient way to perform this task. Doctrine 2 provides the ability
to <tt class="docutils literal"><span class="pre">join</span></tt> related entities together when querying the database. This way we can
pull the <tt class="docutils literal"><span class="pre">Blog</span></tt> and related <tt class="docutils literal"><span class="pre">Comment</span></tt> entities out from the database in one query.
Update the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> code in the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Repository/BlogRepository.php</span></tt> to join on the comments.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Repository/BlogRepository.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getLatestBlogs</span><span class="p">(</span><span class="nv">$limit</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;b, c&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">leftJoin</span><span class="p">(</span><span class="s1">&#39;b.comments&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">addOrderBy</span><span class="p">(</span><span class="s1">&#39;b.created&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$limit</span><span class="p">))</span>
        <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$limit</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
              <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you now refresh the homepage and examine the Doctrine 2 output in the developer
toolbar you will notice the number of queries has dropped. You can also see the comment
table has been joined to the blog table.</p>
<p>Lazy loading and joining related entities are both very powerful concepts but
they need to be used correctly. The correct balance between the 2 needs to be
found to ensure your application is running as efficiently as possible. At first
it might seem great to join on every related entity so you never need to lazy
load and your database query count will always remain low. However, it&#8217;s
important to remember that the more information you retrieve from the database,
the more processing needs to be done by Doctrine 2 to hydrate this into the
entity objects. More data also means more memory is used by the server to store
the entity objects.</p>
<p>Before moving on let&#8217;s make one minor addition to the homepage template for the
number of comments we have just added. Update the homepage template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/index.html.twig</span></tt> to add a link to
show the blog comments.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/index.html.twig #}

{# .. #}

<span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;meta&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>Comments: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id }) }}#comments&quot;</span><span class="nt">&gt;</span>{{ blog.comments|length }}<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Posted by <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.author }}<span class="nt">&lt;/span&gt;</span> at {{ blog.created|date(&#39;h:iA&#39;) }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Tags: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.tags }}<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/footer&gt;</span>

{# .. #}
</pre></div>
</div>
</div>
<div class="section" id="the-sidebar">
<h2>The Sidebar<a class="headerlink" href="#the-sidebar" title="Permalink to this headline">¶</a></h2>
<p>Currently the sidebar of symblog is looking a bit empty. We will update this
with 2 common blog components, the Tag Cloud and a list of the Latest Comments.</p>
<div class="section" id="tag-cloud">
<h3>Tag Cloud<a class="headerlink" href="#tag-cloud" title="Permalink to this headline">¶</a></h3>
<p>The Tag Cloud shows tags for each blog emphasized in a way that displays the
more common tags bolder. To achieve this we need a way to retrieve all the tags
for all the blogs. Let&#8217;s create some new methods in the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> class
to do this. Update the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Repository/BlogRepository.php</span></tt> with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Repository/BlogRepository.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getTags</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$blogTags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                     <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;b.tags&#39;</span><span class="p">)</span>
                     <span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
                     <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>

    <span class="nv">$tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$blogTags</span> <span class="k">as</span> <span class="nv">$blogTag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$tags</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$blogTag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]),</span> <span class="nv">$tags</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$tags</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$tag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$tag</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$tags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getTagWeights</span><span class="p">(</span><span class="nv">$tags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$tagWeights</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tags</span><span class="p">))</span>
        <span class="k">return</span> <span class="nv">$tagWeights</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$tags</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$tagWeights</span><span class="p">[</span><span class="nv">$tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$tagWeights</span><span class="p">[</span><span class="nv">$tag</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$tagWeights</span><span class="p">[</span><span class="nv">$tag</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Shuffle the tags</span>
    <span class="nb">uksort</span><span class="p">(</span><span class="nv">$tagWeights</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">rand</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nv">$max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">$tagWeights</span><span class="p">);</span>

    <span class="c1">// Max of 5 weights</span>
    <span class="nv">$multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$max</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">/</span> <span class="nv">$max</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$tagWeights</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$tag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$tag</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="nv">$tag</span> <span class="o">*</span> <span class="nv">$multiplier</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$tagWeights</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the tags are stored in the database as comma separated values (CSV) we need a
way to split them and return them as an array. This is achieved by the <tt class="docutils literal"><span class="pre">getTags()</span></tt>
method. The <tt class="docutils literal"><span class="pre">getTagWeights()</span></tt> method is then able to use an array of tags to calculate
the weight of each tag based on its popularity within the array. The tags are also
shuffled to randomise their display on the page.</p>
<p>Now we are able to generate the Tag Cloud, we need to display it. Create a new
action in the <tt class="docutils literal"><span class="pre">PageController</span></tt> located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/PageController.php</span></tt> to handle the sidebar.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/PageController.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">sidebarAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
               <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">getTags</span><span class="p">();</span>

    <span class="nv">$tagWeights</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog&#39;</span><span class="p">)</span>
                     <span class="o">-&gt;</span><span class="na">getTagWeights</span><span class="p">(</span><span class="nv">$tags</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Page:sidebar.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tagWeights</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The action is very simple, it uses the 2 new <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> methods to generate
the Tag Cloud, and passes this over to the view. Now let&#8217;s create this view located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig</span></tt>.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig #}

<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;section&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;h3&gt;</span>Tag Cloud<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;tags&quot;</span><span class="nt">&gt;</span>
        {% for tag, weight in tags %}
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;weight-{{ weight }}&quot;</span><span class="nt">&gt;</span>{{ tag }}<span class="nt">&lt;/span&gt;</span>
        {% else %}
            There are no tags
        {% endfor %}
    <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/section&gt;</span>
</pre></div>
</div>
<p>The template is also very simple. It just iterates over the various tags
setting a class to the weight of the tag. The <tt class="docutils literal"><span class="pre">for</span></tt> loop introduces how to
access the <tt class="docutils literal"><span class="pre">key</span></tt> and <tt class="docutils literal"><span class="pre">value</span></tt> pairs of the array, with <tt class="docutils literal"><span class="pre">tag</span></tt> being the key
and <tt class="docutils literal"><span class="pre">weight</span></tt> being the value. There are a number of variations of how to use
the <tt class="docutils literal"><span class="pre">for</span></tt> loop provided in the
<a class="reference external" href="http://twig.sensiolabs.org/doc/templates.html#for">Twig documentation</a>.</p>
<p>Now that we have the template done, we&#8217;ll be render the sidebar inside our main layout template.
To do this, we&#8217;ll want to create a new entry in our routing file located at</p>
<p><tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/config/routing.yml</span></tt></p>
<div class="highlight-yml"><pre># src/Blogger/BlogBundle/Resources/config/routing.yml
BloggerBlogBundle_sidebar:
pattern:  /sidebar
defaults: { _controller: BloggerBlogBundle:Page:sidebar }
requirements:
    _method:  GET</pre>
</div>
<p>If you look back at the <tt class="docutils literal"><span class="pre">BloggerBlogBundle</span></tt> main layout template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/layout.html.twig</span></tt> you will notice
we put a placeholder in for the sidebar block. Let&#8217;s replace this now by rendering
the new sidebar action. Remember from the previous chapter that the Twig <tt class="docutils literal"><span class="pre">render</span></tt>
method will render the contents from a controller action using the <tt class="docutils literal"><span class="pre">sidebar</span></tt> route.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/layout.html.twig #}

{# .. #}

{% block sidebar %}
    {% render url(&quot;BloggerBlogBundle_sidebar&quot;) %}
{% endblock %}
</pre></div>
</div>
<p>Finally let&#8217;s add the CSS for the tag cloud. Add a new stylesheet located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/public/css/sidebar.css</span></tt>.</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nc">.sidebar</span> <span class="nc">.section</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nt">h3</span> <span class="p">{</span> <span class="k">line-height</span><span class="o">:</span> <span class="m">1.2em</span><span class="p">;</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span> <span class="k">font-weight</span><span class="o">:</span> <span class="k">normal</span><span class="p">;</span> <span class="k">background</span><span class="o">:</span> <span class="m">#eee</span><span class="p">;</span> <span class="k">padding</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>  <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nt">p</span> <span class="p">{</span> <span class="k">line-height</span><span class="o">:</span> <span class="m">1.5em</span><span class="p">;</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nt">ul</span> <span class="p">{</span> <span class="k">list-style</span><span class="o">:</span> <span class="k">none</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="p">{</span> <span class="k">line-height</span><span class="o">:</span> <span class="m">1.5em</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.small</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.comment</span> <span class="nt">p</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.comment</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span> <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="p">{</span> <span class="k">font-weight</span><span class="o">:</span> <span class="k">bold</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="nt">span</span> <span class="p">{</span> <span class="k">color</span><span class="o">:</span> <span class="m">#000</span><span class="p">;</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="nc">.weight-1</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="nc">.weight-2</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">15px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="nc">.weight-3</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">18px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="nc">.weight-4</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">21px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.sidebar</span> <span class="nc">.tags</span> <span class="nc">.weight-5</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">24px</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>As we have added a new stylesheet we need to include it. Update the
<tt class="docutils literal"><span class="pre">BloggerBlogBundle</span></tt> main layout template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/layout.html.twig</span></tt> with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/layout.html.twig #}

{# .. #}

{% block stylesheets %}
    {{ parent() }}
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset(&#39;bundles/bloggerblog/css/blog.css&#39;) }}&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset(&#39;bundles/bloggerblog/css/sidebar.css&#39;) }}&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="nt">/&gt;</span>
{% endblock %}

{# .. #}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you are not using the symlink method for referencing bundle assets into the
<tt class="docutils literal"><span class="pre">web</span></tt> folder you must re-run the assets install task now to copy over the
new CSS file.</p>
<div class="last highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console assets:install web
</pre></div>
</div>
</div>
<p>If you now refresh the symblog website you will see the Tag Cloud rendered in the sidebar.
In order to get the tags to render with different weights, you may need to update
the blog fixtures so some tags are used more than others.</p>
</div>
<div class="section" id="recent-comments">
<h3>Recent Comments<a class="headerlink" href="#recent-comments" title="Permalink to this headline">¶</a></h3>
<p>Now the Tag Cloud is in place, let&#8217;s also add the Latest Comments component to the
sidebar.</p>
<p>First we need a way to retrieve the latest comments for the blogs. To do this
we will add a new method to the <tt class="docutils literal"><span class="pre">CommentRepository</span></tt> located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Repository/CommentRepository.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Repository/CommentRepository.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getLatestComments</span><span class="p">(</span><span class="nv">$limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">addOrderBy</span><span class="p">(</span><span class="s1">&#39;c.id&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$limit</span><span class="p">))</span>
        <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$limit</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
              <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next update the sidebar action located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/PageController.php</span></tt>
to retrieve the latest comments and pass them over to the view.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/PageController.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">sidebarAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="nv">$commentLimit</span>   <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span>
                           <span class="o">-&gt;</span><span class="na">getParameter</span><span class="p">(</span><span class="s1">&#39;blogger_blog.comments.latest_comment_limit&#39;</span><span class="p">);</span>
    <span class="nv">$latestComments</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Comment&#39;</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">getLatestComments</span><span class="p">(</span><span class="nv">$commentLimit</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Page:sidebar.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;latestComments&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$latestComments</span><span class="p">,</span>
        <span class="s1">&#39;tags&#39;</span>              <span class="o">=&gt;</span> <span class="nv">$tagWeights</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You will notice we have used a new parameter called
<tt class="docutils literal"><span class="pre">blogger_blog.comments.latest_comment_limit</span></tt> to limit the number of comments
retrieved. To create this parameter
update the config located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/config/config.yml</span></tt> with the following.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Blogger/BlogBundle/Resources/config/config.yml</span>

<span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
    <span class="c1"># ..</span>

    <span class="c1"># Blogger max latest comments</span>
    <span class="l-Scalar-Plain">blogger_blog.comments.latest_comment_limit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</pre></div>
</div>
<p>Finally we need to render the latest comments in the sidebar template. Update the
template located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig</span></tt>
with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig #}

{# .. #}

<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;section&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;h3&gt;</span>Latest Comments<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    {% for comment in latestComments %}
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;comment&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;small&quot;</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ comment.user }}<span class="nt">&lt;/span&gt;</span> commented on
                    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: comment.blog.id }) }}#comment-{{ comment.id }}&quot;</span><span class="nt">&gt;</span>
                        {{ comment.blog.title }}
                    <span class="nt">&lt;/a&gt;</span>
                    [<span class="nt">&lt;em&gt;&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;{{ comment.created|date(&#39;c&#39;) }}&quot;</span><span class="nt">&gt;</span>{{ comment.created|date(&#39;Y-m-d h:iA&#39;) }}<span class="nt">&lt;/time&gt;&lt;/em&gt;</span>]
                <span class="nt">&lt;/p&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;p&gt;</span>{{ comment.comment }}<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
    {% else %}
        <span class="nt">&lt;p&gt;</span>There are no recent comments<span class="nt">&lt;/p&gt;</span>
    {% endfor %}
<span class="nt">&lt;/section&gt;</span>
</pre></div>
</div>
<p>If you now refresh the symblog website you will see the Latest Comments
being displayed in the sidebar under the Tag Cloud.</p>
<img alt="Sidebar - Tag Cloud and Latest Comments" class="align-center" src="../_images/sidebar.jpg" />
</div>
</div>
<div class="section" id="twig-extensions">
<h2>Twig Extensions<a class="headerlink" href="#twig-extensions" title="Permalink to this headline">¶</a></h2>
<p>So far we have been displaying the posted at dates for blog comments in a standard date format
such as <cite>2011-04-21</cite>. A much nicer approach would be to display comment dates in terms
of how long ago the comment was posted, such as <cite>posted 3 hours ago</cite>. We could
add a method to the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity to achieve this and change the templates
to use this method instead of <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">comment.created|date('Y-m-d</span> <span class="pre">h:iA')</span> <span class="pre">}}</span></tt>.</p>
<p>As we may want to use this functionality elsewhere it would make more sense to
move it out of the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity. As transforming the date is specifically
a view layer task, we should implement this using the Twig templating engine.
Twig give us this ability by providing an Extension interface.</p>
<p>We can use the <a class="reference external" href="http://www.twig-project.org/doc/extensions.html">extension</a>
interface in Twig to extend the default functionality it provides. We are
going to create a new Twig filter extension that can be used as follows.</p>
<div class="highlight-html"><div class="highlight"><pre>{{ comment.created|created_ago }}
</pre></div>
</div>
<p>This would return the comment created date in a format such as <cite>posted 2 days ago</cite>.</p>
<div class="section" id="the-extension">
<h3>The Extension<a class="headerlink" href="#the-extension" title="Permalink to this headline">¶</a></h3>
<p>Create a file for the Twig extension located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Twig/Extensions/BloggerBlogExtension.php</span></tt> and updated with
the following content.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Twig/Extensions/BloggerBlogExtension.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Twig\Extensions</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BloggerBlogExtension</span> <span class="k">extends</span> <span class="nx">\Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFilters</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;created_ago&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">\Twig_SimpleFilter</span><span class="p">(</span><span class="s1">&#39;created_ago&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;createdAgo&#39;</span><span class="p">))</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createdAgo</span><span class="p">(</span><span class="nx">\DateTime</span> <span class="nv">$dateTime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$delta</span> <span class="o">=</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="nv">$dateTime</span><span class="o">-&gt;</span><span class="na">getTimestamp</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="s2">&quot;createdAgo is unable to handle dates in the future&quot;</span><span class="p">);</span>

        <span class="nv">$duration</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Seconds</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nv">$delta</span><span class="p">;</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; second&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;=</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Mins</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="nv">$delta</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; minute&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;=</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Hours</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="nv">$delta</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">);</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; hour&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">// Days</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="nv">$delta</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">);</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; day&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$duration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;blogger_blog_extension&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Creating the extension is quite simple. We override the <tt class="docutils literal"><span class="pre">getFilters()</span></tt> method
to return any number of filters we want to be available. In this case
we are creating the <tt class="docutils literal"><span class="pre">created_ago</span></tt> filter. This filter is then registered to use the
<tt class="docutils literal"><span class="pre">createdAgo</span></tt> method, which simply transforms a <tt class="docutils literal"><span class="pre">DateTime</span></tt> object into a
string representing the duration passed since the value stored in the <tt class="docutils literal"><span class="pre">DateTime</span></tt> object.</p>
</div>
<div class="section" id="registering-the-extension">
<h3>Registering the Extension<a class="headerlink" href="#registering-the-extension" title="Permalink to this headline">¶</a></h3>
<p>To make the Twig extension available we need to update the services file
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/config/services.yml</span></tt> with
the following.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">blogger_blog.twig.extension</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Blogger\BlogBundle\Twig\Extensions\BloggerBlogExtension</span>
        <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">name</span><span class="p-Indicator">:</span> <span class="nv">twig.extension</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
<p>You can see this is registering a new service using the <tt class="docutils literal"><span class="pre">BloggerBlogExtension</span></tt>
Twig extension class we have just created.</p>
</div>
<div class="section" id="updating-the-view">
<h3>Updating the view<a class="headerlink" href="#updating-the-view" title="Permalink to this headline">¶</a></h3>
<p>The new Twig filter is now ready to be used. Let&#8217;s update the sidebar Latest Comments
list to use the <tt class="docutils literal"><span class="pre">created_ago</span></tt> filter. Update the sidebar template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig</span></tt> with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig #}

{# .. #}

<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;section&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;h3&gt;</span>Latest Comments<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    {% for comment in latestComments %}
        {# .. #}
        <span class="nt">&lt;em&gt;&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;{{ comment.created|date(&#39;c&#39;) }}&quot;</span><span class="nt">&gt;</span>{{ comment.created|created_ago }}<span class="nt">&lt;/time&gt;&lt;/em&gt;</span>
        {# .. #}
    {% endfor %}
<span class="nt">&lt;/section&gt;</span>
</pre></div>
</div>
<p>If you now point your browser to <tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/</span></tt> you will
see the latest comment dates are using the Twig filter to render the duration
since the comment was posted.</p>
<p>Let&#8217;s also update the comments listed on the blog show page to use the new
filter. Replace the content in the template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Comment/index.html.twig</span></tt> with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Comment/index.html.twig #}

{% for comment in comments %}
    <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;comment {{ cycle([&#39;odd&#39;, &#39;even&#39;], loop.index0) }}&quot;</span> <span class="na">id=</span><span class="s">&quot;comment-{{ comment.id }}&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;header&gt;</span>
            <span class="nt">&lt;p&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ comment.user }}<span class="nt">&lt;/span&gt;</span> commented <span class="nt">&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;{{ comment.created|date(&#39;c&#39;) }}&quot;</span><span class="nt">&gt;</span>{{ comment.created|created_ago }}<span class="nt">&lt;/time&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/header&gt;</span>
        <span class="nt">&lt;p&gt;</span>{{ comment.comment }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/article&gt;</span>
{% else %}
    <span class="nt">&lt;p&gt;</span>There are no comments for this post. Be the first to comment...<span class="nt">&lt;/p&gt;</span>
{% endfor %}
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">There are a number of useful Twig extensions available via the
<a class="reference external" href="https://github.com/fabpot/Twig-extensions">Twig-Extensions</a>  library on GitHub.
If you create a useful extension send over a pull request for this repository and
it may get included for other people to use.</p>
</div>
</div>
</div>
<div class="section" id="slugifying-the-url">
<h2>Slugifying the URL<a class="headerlink" href="#slugifying-the-url" title="Permalink to this headline">¶</a></h2>
<p>Currently the URL for each blog post only shows the blog ID. While this is
perfectly acceptable from a functional point of view, it&#8217;s not great for SEO.
For example, the URL <tt class="docutils literal"><span class="pre">http://symblog.dev/1</span></tt> doesn&#8217;t give any information away about
the content of the blog, something like <tt class="docutils literal"><span class="pre">http://symblog.dev/1/a-day-with-symfony2</span></tt>
would be much better. To achieve this we will slugify the blog title and use it
as part of this URL. Slugifying the title will remove all non ASCII characters
and replace them with a <tt class="docutils literal"><span class="pre">-</span></tt>.</p>
<div class="section" id="update-the-routing">
<h3>Update the routing<a class="headerlink" href="#update-the-routing" title="Permalink to this headline">¶</a></h3>
<p>To begin let&#8217;s modify the routing rule for the blog show page to add the slug component.
Update the routing rule located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/config/routing.yml</span></tt></p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Blogger/BlogBundle/Resources/config/routing.yml</span>

<span class="l-Scalar-Plain">BloggerBlogBundle_blog_show</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/{id}/{slug}</span>
    <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">BloggerBlogBundle</span><span class="p-Indicator">:</span><span class="nv">Blog</span><span class="p-Indicator">:</span><span class="nv">show</span> <span class="p-Indicator">}</span>
    <span class="l-Scalar-Plain">requirements</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">_method</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">GET</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">\d+</span>
</pre></div>
</div>
</div>
<div class="section" id="the-controller">
<h3>The controller<a class="headerlink" href="#the-controller" title="Permalink to this headline">¶</a></h3>
<p>As with the existing <tt class="docutils literal"><span class="pre">id</span></tt> component, the new <tt class="docutils literal"><span class="pre">slug</span></tt> component will be passed
into the controller action as an argument, so let&#8217;s update the controller
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/BlogController.php</span></tt> to reflect
this.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/BlogController.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$slug</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The order in which the arguments are passed into the controller action
doesn&#8217;t matter, only the name of them does. Symfony2 is able to match up the
routing arguments with the parameter list for us. While we haven&#8217;t yet used
default component values it&#8217;s worth mentioning them here. If we added another
component onto the routing rule we can specify a default value for the component
using the <tt class="docutils literal"><span class="pre">defaults</span></tt> option.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">BloggerBlogBundle_blog_show</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/{id}/{slug}/{comments}</span>
    <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">BloggerBlogBundle</span><span class="p-Indicator">:</span><span class="nv">Blog</span><span class="p-Indicator">:</span><span class="nv">show</span><span class="p-Indicator">,</span> <span class="nv">comments</span><span class="p-Indicator">:</span> <span class="nv">true</span> <span class="p-Indicator">}</span>
    <span class="l-Scalar-Plain">requirements</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">_method</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">GET</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">\d+</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$slug</span><span class="p">,</span> <span class="nv">$comments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="last">Using this method, a request to <tt class="docutils literal"><span class="pre">http://symblog.dev/1/symfony2-blog</span></tt> would
result in <tt class="docutils literal"><span class="pre">$comments</span></tt> being set to true in the <tt class="docutils literal"><span class="pre">showAction</span></tt>.</p>
</div>
</div>
<div class="section" id="slugifying-the-title">
<h3>Slugifying the title<a class="headerlink" href="#slugifying-the-title" title="Permalink to this headline">¶</a></h3>
<p>As we want to generate the slug from the blog title, we will auto generate the slug
value. We could simply perform this operation at run time on the title field
but instead we will store the slug in the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity and persist it to the database.</p>
</div>
<div class="section" id="updating-the-blog-entity">
<h3>Updating the Blog entity<a class="headerlink" href="#updating-the-blog-entity" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s add a new member to the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity to store the slug. Update the <tt class="docutils literal"><span class="pre">Blog</span></tt>
entity located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt></p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>

<span class="k">class</span> <span class="nc">Blog</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$slug</span><span class="p">;</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now generate the accessors for the new <tt class="docutils literal"><span class="pre">$slug</span></tt> member. As before run the following task.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:generate:entities Blogger
</pre></div>
</div>
<p>Next, let&#8217;s update the database schema.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:migrations:diff
<span class="nv">$ </span>php app/console doctrine:migrations:migrate
</pre></div>
</div>
<p>To generate the slug value we will use the slugify method from the symfony 1
<a class="reference external" href="http://www.symfony-project.org/jobeet/1_4/Propel/en/08">Jobeet</a> tutorial.
Add the <tt class="docutils literal"><span class="pre">slugify</span></tt> method to the  the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt></p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">slugify</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// replace non letter or digits by -</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;#[^\\pL\d]+#u&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>

    <span class="c1">// trim</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>

    <span class="c1">// transliterate</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;iconv&#39;</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$text</span> <span class="o">=</span> <span class="nb">iconv</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;us-ascii//TRANSLIT&#39;</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// lowercase</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>

    <span class="c1">// remove unwanted characters</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;#[^-\w]+#&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$text</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;n-a&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$text</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As we want to auto generate the slug from the title we can generate the slug when
the value of the title is set. For this we can update the <tt class="docutils literal"><span class="pre">setTitle</span></tt> accessor
to also set the value of the slug. Update the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt> with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="nv">$title</span><span class="p">;</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setSlug</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next update the <tt class="docutils literal"><span class="pre">setSlug</span></tt> method to slugify the slug before it is set.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">setSlug</span><span class="p">(</span><span class="nv">$slug</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">slug</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="nv">$slug</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now reload the data fixtures to generate the blog slugs.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:fixtures:load
</pre></div>
</div>
</div>
<div class="section" id="updating-the-generated-routes">
<h3>Updating the generated routes<a class="headerlink" href="#updating-the-generated-routes" title="Permalink to this headline">¶</a></h3>
<p>Finally we need to update the existing calls for generating routes to the blog
show page. There are a number of locations where this needs to be updated.</p>
<p>Open the homepage template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/index.html.twig</span></tt> and replace its
contents with the following. There have been 3 edits to the generation of the
<tt class="docutils literal"><span class="pre">BloggerBlogBundle_blog_show</span></tt> route in this template. The edits simply
pass in the blog slug to the Twig <tt class="docutils literal"><span class="pre">path</span></tt> function.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/index.html.twig #}

{% extends &#39;BloggerBlogBundle::layout.html.twig&#39; %}

{% block body %}
    {% for blog in blogs %}
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;blog&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;{{ blog.created|date(&#39;c&#39;) }}&quot;</span><span class="nt">&gt;</span>{{ blog.created|date(&#39;l, F j, Y&#39;) }}<span class="nt">&lt;/time&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;header&gt;</span>
                <span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id, &#39;slug&#39;: blog.slug }) }}&quot;</span><span class="nt">&gt;</span>{{ blog.title }}<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>

            <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ asset([&#39;images/&#39;, blog.image]|join) }}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;snippet&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p&gt;</span>{{ blog.blog(500) }}<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;continue&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id, &#39;slug&#39;: blog.slug }) }}&quot;</span><span class="nt">&gt;</span>Continue reading...<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;meta&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p&gt;</span>Comments: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id, &#39;slug&#39;: blog.slug }) }}#comments&quot;</span><span class="nt">&gt;</span>{{ blog.comments|length }}<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
                <span class="nt">&lt;p&gt;</span>Posted by <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.author }}<span class="nt">&lt;/span&gt;</span> at {{ blog.created|date(&#39;h:iA&#39;) }}<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;p&gt;</span>Tags: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.tags }}<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/footer&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
    {% else %}
        <span class="nt">&lt;p&gt;</span>There are no blog entries for symblog<span class="nt">&lt;/p&gt;</span>
    {% endfor %}
{% endblock %}
</pre></div>
</div>
<p>Also, one update needs to be made to the Latest Comments section of the sidebar
template located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig</span></tt>.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/sidebar.html.twig #}

{# .. #}

<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: comment.blog.id, &#39;slug&#39;: comment.blog.slug }) }}#comment-{{ comment.id }}&quot;</span><span class="nt">&gt;</span>
    {{ comment.blog.title }}
<span class="nt">&lt;/a&gt;</span>

{# .. #}
</pre></div>
</div>
<p>Finally the <tt class="docutils literal"><span class="pre">createAction</span></tt> of the <tt class="docutils literal"><span class="pre">CommentController</span></tt> needs to be updated
when redirecting to the blog show page on a successful comment posting. Update
the <tt class="docutils literal"><span class="pre">CommentController</span></tt> located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/CommentController.php</span></tt>
with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/CommentController.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// ..</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle_blog_show&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getBlog</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">(),</span>
            <span class="s1">&#39;slug&#39;</span>  <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getBlog</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getSlug</span><span class="p">()))</span> <span class="o">.</span>
            <span class="s1">&#39;#comment-&#39;</span> <span class="o">.</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now if you navigate to the symblog homepage at <tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/</span></tt>
and click one of the blog titles you will see the blog slug has been
appended to the end of the URL.</p>
</div>
</div>
<div class="section" id="environments">
<h2>Environments<a class="headerlink" href="#environments" title="Permalink to this headline">¶</a></h2>
<p>Environments are a very powerful, yet simple feature provided by Symfony2. You may
not be aware, but you have been using environments from part 1 of this tutorial.
With environments we can configure various aspects of Symfony2 and the application
to run differently depending on the specific needs during the applications life cycle.
By default Symfony2 comes configured with 3 environments:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">dev</span></tt> - Development</li>
<li><tt class="docutils literal"><span class="pre">test</span></tt> - Test</li>
<li><tt class="docutils literal"><span class="pre">prod</span></tt> - Production</li>
</ol>
<p>The purpose of these environments is self explanatory, but what about these environments
would be configured differently for their individual needs. When developing the
application it&#8217;s useful to have the developer toolbar on screen with descriptive
exceptions and errors being displayed, while in production you don&#8217;t want any
of this. In fact, having this information displayed would be a security risk as a lot of
details regarding the internals of the application and the server would be
exposed. In production it would be better to display customised error pages
with simplified messages, while quietly logging this information to text files.
It would also be useful to have the caching layer enabled to ensure the
application is running at its best. Having the caching layer enabled in the
<tt class="docutils literal"><span class="pre">development</span></tt> environment would be a pain as you would need to empty the cache
each time you made changes to config files, etc.</p>
<p>The other environment is the <tt class="docutils literal"><span class="pre">test</span></tt> environment. This is used when running
tests on the application such as unit or functional test. We haven&#8217;t covered
testing yet, but rest assured it will be covered in depth in the coming chapters.</p>
<div class="section" id="front-controllers">
<h3>Front Controllers<a class="headerlink" href="#front-controllers" title="Permalink to this headline">¶</a></h3>
<p>So far through this tutorial we have been using the <tt class="docutils literal"><span class="pre">development</span></tt> environment
only. We have been specifying to run in the <tt class="docutils literal"><span class="pre">development</span></tt> environment by using the
<tt class="docutils literal"><span class="pre">app_dev.php</span></tt> front controller when making requests to symblog, eg
<tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/about</span></tt>. If we have a look at the front
controller located at <tt class="docutils literal"><span class="pre">web/app_dev.php</span></tt> you will see the following line:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="nv">$kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppKernel</span><span class="p">(</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<p>This line is what kick starts Symfony2 going. It instantiates a new instance of
the Symfony2 <tt class="docutils literal"><span class="pre">AppKernel</span></tt> and sets the environment to <tt class="docutils literal"><span class="pre">dev</span></tt>.</p>
<p>In contrast, if we look at the front controller for the <tt class="docutils literal"><span class="pre">production</span></tt> environment
located at <tt class="docutils literal"><span class="pre">web/app.php</span></tt> we see the following:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="nv">$kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppKernel</span><span class="p">(</span><span class="s1">&#39;prod&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
<p>You can see the <tt class="docutils literal"><span class="pre">prod</span></tt> environment is passed into the <tt class="docutils literal"><span class="pre">AppKernel</span></tt> in this instance.</p>
<p>The test environment is not supposed to be run via the web browser which is why there
is no <tt class="docutils literal"><span class="pre">app_test.php</span></tt> front controller.</p>
</div>
<div class="section" id="configuration-settings">
<h3>Configuration Settings<a class="headerlink" href="#configuration-settings" title="Permalink to this headline">¶</a></h3>
<p>We have seen above how the front controllers are utilised to change the environment
the application runs under. Now we will explore how the various settings are
modified while running under each environment. If you have a look at the files in
<tt class="docutils literal"><span class="pre">app/config</span></tt> you will see a number of <tt class="docutils literal"><span class="pre">config.yml</span></tt> files. Specifically
there is one main one, called <tt class="docutils literal"><span class="pre">config.yml</span></tt> and 3 others all suffixed with the
name of an environment; <tt class="docutils literal"><span class="pre">config_dev.yml</span></tt>, <tt class="docutils literal"><span class="pre">config_test.yml</span></tt> and <tt class="docutils literal"><span class="pre">config_prod.yml</span></tt>.
Each of these files is loaded depending on the current environment. If we explore the
<tt class="docutils literal"><span class="pre">config_dev.yml</span></tt> file you will see the following lines at the top.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">imports</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">resource</span><span class="p-Indicator">:</span> <span class="nv">config.yml</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">imports</span></tt> directive will cause the <tt class="docutils literal"><span class="pre">config.yml</span></tt> file to be included into
this file. The same <tt class="docutils literal"><span class="pre">imports</span></tt> directive can be found at the top of the other 2
environment config files, <tt class="docutils literal"><span class="pre">config_test.yml</span></tt> and <tt class="docutils literal"><span class="pre">config_prod.yml</span></tt>. By
including a common set of config settings defined in <tt class="docutils literal"><span class="pre">config.yml</span></tt> we are able
to override specific settings for each environment. We can
see in the <tt class="docutils literal"><span class="pre">development</span></tt> config file located at <tt class="docutils literal"><span class="pre">app/config/config_dev.yml</span></tt>
the following lines configuring the use of the developer toolbar.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config_dev.yml</span>

<span class="l-Scalar-Plain">web_profiler</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">toolbar</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>This setting is absent from the <tt class="docutils literal"><span class="pre">production</span></tt> config file as we don&#8217;t want the
developer toolbar displayed.</p>
</div>
<div class="section" id="running-in-production">
<h3>Running in Production<a class="headerlink" href="#running-in-production" title="Permalink to this headline">¶</a></h3>
<p>For those of you eager to see your site running in the <tt class="docutils literal"><span class="pre">production</span></tt> environment
now is the time.</p>
<p>First we need to clear the cache using one of the Symfony2 tasks.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console cache:clear --env<span class="o">=</span>prod
</pre></div>
</div>
<p>Now point your browser to <tt class="docutils literal"><span class="pre">http://symblog.dev/</span></tt>. Notice the <tt class="docutils literal"><span class="pre">app_dev.php</span></tt> front
controller is missing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For those of you using the Dynamic Virtual Hosts configuration as linked to in
part 1, you will need to add the following to the .htaccess file located
at <tt class="docutils literal"><span class="pre">web/.htaccess</span></tt>.</p>
<div class="last highlight-text"><div class="highlight"><pre>&lt;IfModule mod_rewrite.c&gt;
    RewriteBase /
    # ..
&lt;/IfModule&gt;
</pre></div>
</div>
</div>
<p>You will notice the site looks pretty much the same, but a few important
features are different. The developer toolbar is now gone and the detailed
exception message are no longer displayed, try going to <tt class="docutils literal"><span class="pre">http://symblog.dev/999</span></tt>.</p>
<img alt="Production - 404 Error" class="align-center" src="../_images/production_error.jpg" />
<p>The detailed exception message has been replaced by a simplified message informing
the user of the problem. These exception screens can be customised to match the look
and feel of your application. We will explore this in later chapters.</p>
<p>Furthermore, you&#8217;ll notice the <tt class="docutils literal"><span class="pre">app/logs/prod.log</span></tt> file is filling up with logs regarding
the execution of the application. This is a useful point of call when you have
issues with the application in <tt class="docutils literal"><span class="pre">production</span></tt> as errors and exceptions won&#8217;t be displayed on
the screen any more.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>How did the request to <tt class="docutils literal"><span class="pre">http://symblog.dev/</span></tt> end up being routed through the
file <tt class="docutils literal"><span class="pre">app.php</span></tt>? I&#8217;m sure you&#8217;re all used to creating files such as <tt class="docutils literal"><span class="pre">index.html</span></tt>
and <tt class="docutils literal"><span class="pre">index.php</span></tt> that act as the site&#8217;s index, but how would <tt class="docutils literal"><span class="pre">app.php</span></tt>
become this? This is thanks to a RewriteRule in the file <tt class="docutils literal"><span class="pre">web/.htaccess</span></tt></p>
<div class="highlight-text"><div class="highlight"><pre>RewriteRule ^(.*)$ app.php [QSA,L]
</pre></div>
</div>
<p>We can see that this line has a regular expression that matches any text,
denoted by <tt class="docutils literal"><span class="pre">^(.*)$</span></tt> and passes this to <tt class="docutils literal"><span class="pre">app.php</span></tt>.</p>
<p class="last">You may be on an Apache server that doesn&#8217;t have the <tt class="docutils literal"><span class="pre">mod_rewrite.c</span></tt>
enabled. If this is the case you can simply add <tt class="docutils literal"><span class="pre">app.php</span></tt> to the URL such as
<tt class="docutils literal"><span class="pre">http://symblog.dev/app.php/</span></tt>.</p>
</div>
<p>While we have covered the basics of the <tt class="docutils literal"><span class="pre">production</span></tt> environment, we have not
covered many other <tt class="docutils literal"><span class="pre">production</span></tt> related tasks such as customising
error pages, and deployment to the <tt class="docutils literal"><span class="pre">production</span></tt> server using tools such as
<a class="reference external" href="http://capifony.org/">capifony</a>. These topics will be covered in later chapters.</p>
</div>
<div class="section" id="creating-new-environments">
<h3>Creating New Environments<a class="headerlink" href="#creating-new-environments" title="Permalink to this headline">¶</a></h3>
<p>Finally it&#8217;s worth noting that you can setup your own environments easily in Symfony2.
For example, you may want a staging environment that would run on the production
server, but output some of the debugging information such as exceptions. This
would allow the platform to be tested manually on the actual production server
as production and development configurations of servers can differ.</p>
<p>While creating a new environment is a simple task, it is outside the scope of this
tutorial. There is an excellent
<a class="reference external" href="http://symfony.com/doc/current/cookbook/configuration/environments.html">article</a>
in the Symfony2 cookbook that covers this.</p>
</div>
</div>
<div class="section" id="assetic">
<h2>Assetic<a class="headerlink" href="#assetic" title="Permalink to this headline">¶</a></h2>
<p>The Symfony2 Standard Distribution is bundled with a library for assets
management called <a class="reference external" href="https://github.com/kriswallsmith/assetic">Assetic</a>. The library was
developed by <a class="reference external" href="https://twitter.com/#!/kriswallsmith">Kris Wallsmith</a> and was
inspired by the Python library <a class="reference external" href="http://elsdoerfer.name/files/docs/webassets/">webassets</a>.</p>
<p>Assetic deals with 2 parts of asset management, the assets such as images,
stylesheets and JavaScript and the filters that can be applied to these assets.
These filters are able to perform useful tasks such as minifying your CSS and
JavaScript, passing <a class="reference external" href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a>
files through the CoffeeScript compiler, and combining asset files together to
reduce the number of HTTP requests made to the server.</p>
<p>Currently we have been using the Twig <tt class="docutils literal"><span class="pre">asset</span></tt> function to include assets into
the template as follows.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset(&#39;bundles/bloggerblog/css/blog.css&#39;) }}&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>The calls to the <tt class="docutils literal"><span class="pre">asset</span></tt> function will be replaced by Assetic.</p>
<div class="section" id="assets">
<h3>Assets<a class="headerlink" href="#assets" title="Permalink to this headline">¶</a></h3>
<p>The Assetic library describes an asset as follows:</p>
<p><cite>An Assetic asset is something with filterable content that can be loaded and
dumped. An asset also includes metadata, some of which can be manipulated and
some of which is immutable.</cite></p>
<p>Put simply, the assets are the resources the application uses such as stylesheets
and images.</p>
<p>To enable Assetic for the <tt class="docutils literal"><span class="pre">BloggerBlogBundle</span></tt> we have to change the <tt class="docutils literal"><span class="pre">app/config/config.yml</span></tt> as follows.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1"># ..</span>
<span class="nx">assetic</span><span class="o">:</span>
    <span class="nx">bundles</span><span class="o">:</span>    <span class="p">[</span><span class="nx">BloggerBlogBundle</span><span class="p">]</span>
<span class="c1"># ..</span>
</pre></div>
</div>
<p>This will enable Assetic just for the <tt class="docutils literal"><span class="pre">BloggerBlogBundle</span></tt> and will require adjustments whenever
a new bundle needs to use Assetic. We can however completely remove the <tt class="docutils literal"><span class="pre">bundles</span></tt> line and enable
it for all future bundles aswell.</p>
<div class="section" id="stylesheets">
<h4>Stylesheets<a class="headerlink" href="#stylesheets" title="Permalink to this headline">¶</a></h4>
<p>Let&#8217;s begin by replacing the current calls to <tt class="docutils literal"><span class="pre">asset</span></tt> for the stylesheets
in the <tt class="docutils literal"><span class="pre">BloggerBlogBundle</span></tt> main layout template. Update the content of the template
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/layout.html.twig</span></tt>
with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/layout.html.twig #}

{# .. #}

{% block stylesheets %}
    {{ parent () }}

    {% stylesheets
        &#39;@BloggerBlogBundle/Resources/public/css/*&#39;
    %}
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
    {% endstylesheets %}
{% endblock %}

{# .. #}
</pre></div>
</div>
<p>We have replaced the 2 previous links for CSS files with some Assetic
functionality. Using <tt class="docutils literal"><span class="pre">stylesheets</span></tt> from Assetic we have specified that all CSS
files in the location <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/public/css</span></tt> should be
combined into 1 file and then output. Combining files is a very simple but
effective way to optimise your website frontend by reducing the number of files
needed. Fewer files means fewer HTTP requests to the server. While we used the
<tt class="docutils literal"><span class="pre">*</span></tt> to specify all files in the <tt class="docutils literal"><span class="pre">css</span></tt> directory we could have simply listed
each file individually as follows.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/layout.html.twig #}

{# .. #}

{% block stylesheets %}
    {{ parent () }}

    {% stylesheets
        &#39;@BloggerBlogBundle/Resources/public/css/blog.css&#39;
        &#39;@BloggerBlogBundle/Resources/public/css/sidebar.css&#39;
    %}
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
    {% endstylesheets %}
{% endblock %}

{# .. #}
</pre></div>
</div>
<p>The end result in both cases is the same. The first option using the <tt class="docutils literal"><span class="pre">*</span></tt> ensures
that when new CSS files are added to the directory, they will always be included in the combined CSS
file by Assetic. This may not be the desired functionality for your website, so
use either method above to suit your needs.</p>
<p>If you have a look at the HTML output via <tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/</span></tt>
you will see the CSS has been included something like this (Notice we
are running back in the <tt class="docutils literal"><span class="pre">development</span></tt> environment again).</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/app_dev.php/css/d8f44a4_part_1_blog_1.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/app_dev.php/css/d8f44a4_part_1_sidebar_2.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>Firstly you may be wondering why there are 2 files. Above it was stated that Assetic
would combine the files into 1 CSS file. This is because we are running symblog
in the <tt class="docutils literal"><span class="pre">development</span></tt> environment. We can ask Assetic to run in non-debug mode
by setting the debug flag to false as follows.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/layout.html.twig #}

{# .. #}

{% stylesheets
    &#39;@BloggerBlogBundle/Resources/public/css/*&#39;
    debug=false
%}
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
{% endstylesheets %}

{# .. #}
</pre></div>
</div>
<p>Now if you look at the rendered HTML you will see something like this.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/app_dev.php/css/3c7da45.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>If you view the contents of this file you will see the 2 CSS files, <tt class="docutils literal"><span class="pre">blog.css</span></tt>
and <tt class="docutils literal"><span class="pre">sidebar.css</span></tt> have been combined into 1 file. The filename given to the generated
CSS file is randomly generated by Assetic. If you would like to control the name
given to the generated file use the <tt class="docutils literal"><span class="pre">output</span></tt> option as follows.</p>
<div class="highlight-html"><div class="highlight"><pre>{% stylesheets
    &#39;@BloggerBlogBundle/Resources/public/css/*&#39;
    output=&#39;css/blogger.css&#39;
%}
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
{% endstylesheets %}
</pre></div>
</div>
<p>Before you continue remove the debug flag from the previous snippet as we want
to resume default behavior on the assets.</p>
<p>We also need to update the applications base template located at
<tt class="docutils literal"><span class="pre">app/Resources/views/base.html.twig</span></tt>.</p>
<div class="highlight-html"><div class="highlight"><pre>{# app/Resources/views/base.html.twig #}

{# .. #}

{% block stylesheets %}
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&#39;http://fonts.googleapis.com/css?family=Irish+Grover&#39;</span> <span class="na">rel=</span><span class="s">&#39;stylesheet&#39;</span> <span class="na">type=</span><span class="s">&#39;text/css&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&#39;http://fonts.googleapis.com/css?family=La+Belle+Aurore&#39;</span> <span class="na">rel=</span><span class="s">&#39;stylesheet&#39;</span> <span class="na">type=</span><span class="s">&#39;text/css&#39;</span><span class="nt">&gt;</span>
    {% stylesheets
        &#39;css/*&#39;
    %}
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
    {% endstylesheets %}
{% endblock %}

{# .. #}
</pre></div>
</div>
</div>
<div class="section" id="javascripts">
<h4>JavaScripts<a class="headerlink" href="#javascripts" title="Permalink to this headline">¶</a></h4>
<p>While we currently don&#8217;t have any JavaScipt files in our application, its usage in
Assetic is much the same as using stylesheets.</p>
<div class="highlight-html"><div class="highlight"><pre>{% javascripts
    &#39;@BloggerBlogBundle/Resources/public/js/*&#39;
%}
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;{{ asset_url }}&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
{% endjavascripts %}
</pre></div>
</div>
</div>
</div>
<div class="section" id="filters">
<h3>Filters<a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h3>
<p>The real power in Assetic comes from the filters. Filters can be applied to assets
or collections of assets. There are a large number of filters
provided within the core of the library including the following common filters:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">CssMinFilter</span></tt>: minifies CSS</li>
<li><tt class="docutils literal"><span class="pre">JpegoptimFilter</span></tt>: optimize your JPEGs</li>
<li><tt class="docutils literal"><span class="pre">Yui\CssCompressorFilter</span></tt>: compresses CSS using the YUI compressor</li>
<li><tt class="docutils literal"><span class="pre">Yui\JsCompressorFilter</span></tt>: compresses JavaScript using the YUI compressor</li>
<li><tt class="docutils literal"><span class="pre">CoffeeScriptFilter</span></tt>: compiles CoffeeScript into JavaScript</li>
</ol>
<p>There is a full list of available filters in the
<a class="reference external" href="https://github.com/kriswallsmith/assetic/blob/master/README.md">Assetic Readme</a>.</p>
<p>Many of these filters pass the actual task onto another program or library, such
as YUI Compressor, so you may need to install/configure the appropriate libraries
to use some of the filters.</p>
<p>Download the <a class="reference external" href="http://yuilibrary.com/download/yuicompressor/">YUI Compressor</a>, extract
the archive and copy the file located in the <tt class="docutils literal"><span class="pre">build</span></tt> directory to
<tt class="docutils literal"><span class="pre">app/Resources/java/yuicompressor-2.4.6.jar</span></tt>. This assumes you downloaded the
<tt class="docutils literal"><span class="pre">2.4.6</span></tt> version of the YUI Compressor. If not change your version number accordingly.</p>
<p>Next we will configure an Assetic filter to minify the CSS using the YUI Compressor.
Update the application config located at <tt class="docutils literal"><span class="pre">app/config/config.yml</span></tt> with the following.</p>
<div class="highlight-yaml"><pre># app/config/config.yml

# ..

assetic:
    filters:
        yui_css:
            jar: %kernel.root_dir%/Resources/java/yuicompressor-2.4.6.jar

# ..</pre>
</div>
<p>We have configured a filter called <tt class="docutils literal"><span class="pre">yui_css</span></tt> that will use the YUI Compressor
Java executable we placed in the applications resources directory. In order
to use the filter you need to specify which assets you want the filter applied to.
Update the template located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/layout.html.twig</span></tt>
to apply the <tt class="docutils literal"><span class="pre">yui_css</span></tt> filter.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/layout.html.twig #}

{# .. #}

{% stylesheets
    &#39;@BloggerBlogBundle/Resources/public/css/*&#39;
    output=&#39;css/blogger.css&#39;
    filter=&#39;yui_css&#39;
%}
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
{% endstylesheets %}

{# .. #}
</pre></div>
</div>
<p>Now if you refresh the symblog website and view the files output by Assetic you
will notice they have been minified. While minification is great for production
servers, it can make debugging difficult, especially when JavaScript is
minified. We can disable the minification when running in the <tt class="docutils literal"><span class="pre">development</span></tt>
environment by prefixing the filter with a <tt class="docutils literal"><span class="pre">?</span></tt> as follows.</p>
<div class="highlight-html"><div class="highlight"><pre>{% stylesheets
    &#39;@BloggerBlogBundle/Resources/public/css/*&#39;
    output=&#39;css/blogger.css&#39;
    filter=&#39;?yui_css&#39;
%}
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;{{ asset_url }}&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="nt">/&gt;</span>
{% endstylesheets %}
</pre></div>
</div>
</div>
<div class="section" id="dumping-the-assets-for-production">
<h3>Dumping the assets for production<a class="headerlink" href="#dumping-the-assets-for-production" title="Permalink to this headline">¶</a></h3>
<p>In production we can dump the asset files using Assetic so they become actual
resources on disk ready to be served by the web server. The process of creating
the assets through Assetic with every page request can be quite slow,
especially when filters are being applied to the assets. Dumping the assets
for <tt class="docutils literal"><span class="pre">production</span></tt> ensures that Assetic is not used to serve the assets and instead
the pre-processed asset files are served directly by the web server. Run the following
task to create dump the asset files.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>app/console --env<span class="o">=</span>prod assetic:dump
</pre></div>
</div>
<p>You will notice a number of CSS files were created at <tt class="docutils literal"><span class="pre">web/css</span></tt> including the
combined <tt class="docutils literal"><span class="pre">blogger.css</span></tt> file. Now if you run the symblog website in the <tt class="docutils literal"><span class="pre">production</span></tt>
environment via <tt class="docutils literal"><span class="pre">http://symblog.dev/</span></tt> the files will be served directly
from this folder.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you dump the asset files to disk and want to revert back to the
<tt class="docutils literal"><span class="pre">development</span></tt> environment, you will need to clean up the created asset
files in <tt class="docutils literal"><span class="pre">web/</span></tt> to allow Assetic to recreate them.</p>
</div>
</div>
<div class="section" id="additional-reading">
<h3>Additional Reading<a class="headerlink" href="#additional-reading" title="Permalink to this headline">¶</a></h3>
<p>We have only scratched the surface at what Assetic can perform. There are more resources
available online especially in the Symfony2 cookbook including:</p>
<p><a class="reference external" href="http://symfony.com/doc/current/cookbook/assetic/asset_management.html">How to Use Assetic for Asset Management</a></p>
<p><a class="reference external" href="http://symfony.com/doc/current/cookbook/assetic/yuicompressor.html">How to Minify JavaScripts and Stylesheets with YUI Compressor</a></p>
<p><a class="reference external" href="http://symfony.com/doc/current/cookbook/assetic/jpeg_optimize.html">How to Use Assetic For Image Optimization with Twig Functions</a></p>
<p><a class="reference external" href="http://symfony.com/doc/current/cookbook/assetic/apply_to_option.html">How to Apply an Assetic Filter to a Specific File Extension</a></p>
<p>There are also a number of great article written by <a class="reference external" href="https://twitter.com/#!/mr_r_miller">Richard Miller</a>
including:</p>
<p><a class="reference external" href="http://miller.limethinking.co.uk/2011/05/16/symfony2-using-coffeescript-with-assetic/">Symfony2: Using CoffeeScript with Assetic</a></p>
<p><a class="reference external" href="http://miller.limethinking.co.uk/2011/06/02/symfony2-a-few-assetic-notes/">Symfony2: A Few Assetic Notes</a></p>
<p><a class="reference external" href="http://miller.limethinking.co.uk/2011/06/23/symfony2-assetic-twig-functions/">Symfony2: Assetic Twig Functions</a></p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It&#8217;s worth mentioning here that Richard Miller has a collection of excellent articles
regarding a number of Symfony2 areas on his site including Dependency Injection,
Services and the above mentioned Assetic guides. Just search for posts
tagged with <a class="reference external" href="http://miller.limethinking.co.uk/tag/symfony2/">symfony2</a></p>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>We have covered a number of new areas with regards to Symfony2 including
the Symfony2 environments and how to use the Assetic asset library. We also
made improvements to the homepage and added some components to the sidebar.</p>
<p>In the next chapter we will move on to testing. We will explore both unit
and functional testing using PHPUnit. We will see how Symfony2 comes complete
with a number of classes to assist in writing functional tests that simulate
web requests, allow us to populate forms and click links and then inspect the
returned response.</p>
</div>
</div>



    <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="extending-the-model-blog-comments.html">[Part 4] - The Comments Model: Adding comments,  Doctrine Repositories and Migrations</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="testing-unit-and-functional-phpunit.html">[Part 6] - Testing: Unit and Functional with PHPUnit</a>&#160;&#160;»
        </p>

    </div>

    <div id="disqus_thread"></div>

    <script type="text/javascript">
        var disqus_shortname = 'symblogtutorial';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
  <div class="bottomnav">
  
        <p>
        «&#160;&#160;<a href="extending-the-model-blog-comments.html">[Part 4] - The Comments Model: Adding comments,  Doctrine Repositories and Migrations</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="testing-unit-and-functional-phpunit.html">[Part 6] - Testing: Unit and Functional with PHPUnit</a>&#160;&#160;»
        </p>

  </div>

    <div class="footer">
        &copy; Copyright 2011, dsyph3r.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>