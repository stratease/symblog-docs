
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>[Part 4] - The Comments Model: Adding comments, Doctrine Repositories and Migrations &mdash; symblog - A Symfony2 Tutorial</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="symblog - A Symfony2 Tutorial" href="../index.html" />
    <link rel="next" title="[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic" href="customising-the-view-more-with-twig.html" />
    <link rel="prev" title="[Part 3] - The Blog Model: Using Doctrine 2 and Data Fixtures" href="doctrine-2-the-blog-model.html" />
<!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href='http://fonts.googleapis.com/css?family=Irish+Grover' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=La+Belle+Aurore' rel='stylesheet' type='text/css'>
<style type="text/css">
    #header {line-height: 1;font-family: Arial, Helvetica, sans-serif;font-size: 12px; width: 100%; height: 100%; color: #000; font-size: 14px; }

    html { background: none; }
    a { text-decoration: none !important; color: #F48A00 !important; font-weight: normal !important }

    h1, h2, h3, h4, h5, h6 { color: #000 }

    #header a:link { font-weight: normal !important; }

    #header { border-bottom: 1px solid #ccc; margin-bottom: 20px; }
    #header .top { border-bottom: 1px solid #ccc; margin-bottom: 10px; }
    #header ul.languages { list-style: none; text-align: right; margin-bottom: 0; display: inline-block; }
    #header .languages li { display: inline }
    #header .languages li a { display: inline-block; padding: 10px 10px 10px 25px; border-right: 1px solid #ccc; background-repeat: no-repeat; background-position: 5px center  }
    #header .en { background-image: url('/_static/images/icons/languages/gb.png'); }
    #header .es { background-image: url('/_static/images/icons/languages/es.png'); }
    #header .fr { background-image: url('/_static/images/icons/languages/fr.png'); }
    #header ul.navigation { list-style: none; text-align: right; margin-bottom: 0; display: inline-block; float: right; }
    #header .navigation li { display: inline }
    #header .navigation li a { display: inline-block; padding: 10px 15px; border-left: 1px solid #ccc; }
    #header h2 { font-family: 'Irish Grover', cursive; font-size: 92px; text-align: center; line-height: 110px; border-bottom: none; margin: 0px; font-weight: normal; }
    #header h2 a { color: #000 !important }
    #header h3 { text-align: center; font-family: 'La Belle Aurore', cursive; font-size: 24px; margin: 0; margin-bottom: 20px; font-weight: normal;  font-weight: normal;}

    div.content { font-size: 0.9em; margin: 10px 20px 20px; }

    .note, .tip, .warning {
        border: 1px solid !important;
        margin: 10px 0px !important;
        padding:15px 10px 15px 70px !important;
        background-repeat: no-repeat !important;
        background-position: 10px center !important;
    }
    .note {
        border-color: #00529B !important;
        background-color: #DBF3FF !important;
        background-image: url('../_static/images/icons/note.png') !important;
    }
    .tip {
        border-color: #4F8A10 !important;
        background-color: #E5F2D0 !important;
        background-image:url('../_static/images/icons/tip.png') !important;
        }
    .warning {
        border-color: #9F6000 !important;
        background-color: #FFF7DB !important;
        background-image: url('../_static/images/icons/warning.png') !important;
    }
</style>

  </head>
  <body>

    <header id="header">
        <div class="top">
            <nav>
                <ul class="languages">
                    <li><a href="http://tutorial.symblog.co.uk" class="en">EN</a></li>
                    <li><a href="http://symblog.site90.net/" class="es">ES</a></li>
                    <li><a href="http://keiruaprod.fr/symblog-fr/" class="fr">FR</a></li>
                </ul>
                <ul class="navigation">
                    <li><a href="/">Home</a></li>
                    <li><a href="http://symblog.co.uk">Demo</a></li>
                    <li><a href="https://github.com/dsyph3r/symblog">Source</a></li>
                </ul>
            </nav>
        </div>

        <hgroup>
            <h2><a href="/">symblog</a></h2>
            <h3><a href="/">creating a blog in Symfony2</a></h3>
        </hgroup>
    </header>

  <div class="topnav">
  
        <p>
        «&#160;&#160;<a href="doctrine-2-the-blog-model.html">[Part 3] - The Blog Model: Using Doctrine 2 and Data Fixtures</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="customising-the-view-more-with-twig.html">[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic</a>&#160;&#160;»
        </p>

  </div>
  <div class="content">

    
    
  <div class="section" id="part-4-the-comments-model-adding-comments-doctrine-repositories-and-migrations">
<h1>[Part 4] - The Comments Model: Adding comments,  Doctrine Repositories and Migrations<a class="headerlink" href="#part-4-the-comments-model-adding-comments-doctrine-repositories-and-migrations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This chapter will build on the blog model we defined in the previous chapter. We
will create the comment model, which will handle comments for blog posts. We
will be introduced to creating relationships between models, as a blog post can
contain many comments. We will use the Doctrine 2 QueryBuilder and Doctrine 2
Repository classes to retrieve entities from the database. The concept of
Doctrine 2 Migrations will also be explored which provide a programmatic way to
deploy changes to the database. At the end of this chapter you will have created
the comment model and linked it together with the blog model. We will also have
created the homepage, and provided the ability for users to submit comments
for a blog post.</p>
</div>
<div class="section" id="the-homepage">
<h2>The Homepage<a class="headerlink" href="#the-homepage" title="Permalink to this headline">¶</a></h2>
<p>We will begin this chapter by building the homepage. In true blogger fashion it will
display snippets of each blog post, ordered from newest to oldest. The full
blog post will be available via links to the blog show page. As we have already
built the route, controller and view for the homepage we can simply update these.</p>
<div class="section" id="retrieving-the-blogs-querying-the-model">
<h3>Retrieving the blogs: Querying the model<a class="headerlink" href="#retrieving-the-blogs-querying-the-model" title="Permalink to this headline">¶</a></h3>
<p>In order to display the blogs, we need to retrieve them from the database.
Doctrine 2 provides the
<a class="reference external" href="http://www.doctrine-project.org/docs/orm/2.1/en/reference/dql-doctrine-query-language.html">Doctrine Query Language</a>
(DQL) and a
<a class="reference external" href="http://www.doctrine-project.org/docs/orm/2.1/en/reference/query-builder.html">QueryBuilder</a>
to achieve this (You can also run raw SQL through Doctrine 2 but this method is
discouraged as it takes away the database abstraction Doctrine 2 gives us).
We will use the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> as it provides a nice object oriented way for us to generate
DQL, which we can use to query the database. Let&#8217;s update the <tt class="docutils literal"><span class="pre">index</span></tt> action of the <tt class="docutils literal"><span class="pre">Page</span></tt> controller
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/PageController.php</span></tt>
to pull the blogs from the database.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/PageController.php</span>
<span class="k">class</span> <span class="nc">PageController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
                   <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="nv">$blogs</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">()</span>
                    <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                    <span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog&#39;</span><span class="p">,</span>  <span class="s1">&#39;b&#39;</span><span class="p">)</span>
                    <span class="o">-&gt;</span><span class="na">addOrderBy</span><span class="p">(</span><span class="s1">&#39;b.created&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">)</span>
                    <span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
                    <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Page:index.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;blogs&#39;</span> <span class="o">=&gt;</span> <span class="nv">$blogs</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We begin by getting an instance of the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> from the <tt class="docutils literal"><span class="pre">EntityManager</span></tt>. This
allows us to start constructing the query using the many methods the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt>
provides. The full list of available methods is available via the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt>
documentation. A good place to start is with the
<a class="reference external" href="http://www.doctrine-project.org/docs/orm/2.1/en/reference/query-builder.html#helper-methods">helper methods</a>.
These are the methods we use, such as <tt class="docutils literal"><span class="pre">select()</span></tt>, <tt class="docutils literal"><span class="pre">from()</span></tt> and <tt class="docutils literal"><span class="pre">addOrderBy()</span></tt>.
As with previous interactions with Doctrine 2, we can use the short hand notation
to reference the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity via <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Blog</span></tt> (remember this
is the same as doing <tt class="docutils literal"><span class="pre">Blogger\BlogBundle\Entity\Blog</span></tt>). When we have finished
specifying the criteria for the query, we call the <tt class="docutils literal"><span class="pre">getQuery()</span></tt> method which returns
a <tt class="docutils literal"><span class="pre">DQL</span></tt> instance. We are not able to get results from the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> object, we must
always convert this to a <tt class="docutils literal"><span class="pre">DQL</span></tt> instance first. The <tt class="docutils literal"><span class="pre">DQL</span></tt> instance provides the <tt class="docutils literal"><span class="pre">getResult()</span></tt>
method that returns a collection of <tt class="docutils literal"><span class="pre">Blog</span></tt> entities. We will see later that the <tt class="docutils literal"><span class="pre">DQL</span></tt> instance
has a
<a class="reference external" href="http://www.doctrine-project.org/docs/orm/2.1/en/reference/dql-doctrine-query-language.html#query-result-formats">number of methods</a>
for returning results including <tt class="docutils literal"><span class="pre">getSingleResult()</span></tt> and <tt class="docutils literal"><span class="pre">getArrayResult()</span></tt>.</p>
<div class="section" id="the-view">
<h4>The View<a class="headerlink" href="#the-view" title="Permalink to this headline">¶</a></h4>
<p>Now we have a collection of <tt class="docutils literal"><span class="pre">Blog</span></tt> entities we need to display them.
Replace the content of the homepage template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Page/index.html.twig</span></tt>
with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Page/index.html.twig #}
{% extends &#39;BloggerBlogBundle::layout.html.twig&#39; %}

{% block body %}
    {% for blog in blogs %}
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;blog&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;{{ blog.created|date(&#39;c&#39;) }}&quot;</span><span class="nt">&gt;</span>{{ blog.created|date(&#39;l, F j, Y&#39;) }}<span class="nt">&lt;/time&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;header&gt;</span>
                <span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id }) }}&quot;</span><span class="nt">&gt;</span>{{ blog.title }}<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>

            <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ asset([&#39;images/&#39;, blog.image]|join) }}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;snippet&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p&gt;</span>{{ blog.blog(500) }}<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;continue&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id }) }}&quot;</span><span class="nt">&gt;</span>Continue reading...<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;meta&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p&gt;</span>Comments: -<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;p&gt;</span>Posted by <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{blog.author}}<span class="nt">&lt;/span&gt;</span> at {{ blog.created|date(&#39;h:iA&#39;) }}<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;p&gt;</span>Tags: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ blog.tags }}<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/footer&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
    {% else %}
        <span class="nt">&lt;p&gt;</span>There are no blog entries for symblog<span class="nt">&lt;/p&gt;</span>
    {% endfor %}
{% endblock %}
</pre></div>
</div>
<p>We introduce one of the Twig control structures here, the <tt class="docutils literal"><span class="pre">for..else..endfor</span></tt>
structure. If you have not used a templating engine before you are probably
familiar with the following PHP snippet.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$blogs</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$blogs</span> <span class="k">as</span> <span class="nv">$blog</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;h1&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">getTitle</span><span class="p">()</span> <span class="cp">?&gt;&lt;?</span><span class="nx">h1</span><span class="o">&gt;</span>
        <span class="o">&lt;!--</span> <span class="nx">rest</span> <span class="nx">of</span> <span class="nx">content</span> <span class="o">--&gt;</span>
    <span class="o">&lt;?</span><span class="nx">php</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?php</span> <span class="k">else</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;p&gt;There are no blog entries&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span> <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>The Twig <tt class="docutils literal"><span class="pre">for..else..endfor</span></tt> control structure is a much cleaner way of
achieving this task. Most of the code within the homepage template is concerned with
outputting the blog information in HTML. However, there are a few things we need
to note. Firstly, we make use of the Twig <tt class="docutils literal"><span class="pre">path</span></tt> function to generate the
routes for the blog show page. As the blog show page requires a blog <tt class="docutils literal"><span class="pre">ID</span></tt> to
be present in the URL, we need to pass this as an argument into the <tt class="docutils literal"><span class="pre">path</span></tt>
function. This can be seen with the following.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ path(&#39;BloggerBlogBundle_blog_show&#39;, { &#39;id&#39;: blog.id }) }}&quot;</span><span class="nt">&gt;</span>{{ blog.title }}<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
</pre></div>
</div>
<p>Secondly we output the blog content using <tt class="docutils literal"><span class="pre">&lt;p&gt;{{</span> <span class="pre">blog.blog(500)</span> <span class="pre">}}&lt;/p&gt;</span></tt>.
The <tt class="docutils literal"><span class="pre">500</span></tt> argument we pass in, is the max length of the blog post we want to
receive back from the function. For this to work we need to update the
<tt class="docutils literal"><span class="pre">getBlog</span></tt> method that Doctrine 2 generated for us previously. Update the
<tt class="docutils literal"><span class="pre">getBlog</span></tt> method in the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getBlog</span><span class="p">(</span><span class="nv">$length</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blog</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blog</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the usual behavior of the <tt class="docutils literal"><span class="pre">getBlog</span></tt> method should be to return the entire blog
post, we set the <tt class="docutils literal"><span class="pre">$length</span></tt> parameter to have a default of <tt class="docutils literal"><span class="pre">null</span></tt>. If <tt class="docutils literal"><span class="pre">null</span></tt>
is passed in, the entire blog post is returned.</p>
<p>Now if you point your browser to <tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/</span></tt> you should
see the homepage displaying the latest blog post entries. You should also be able to navigate
to the full blog post for each entry by clicking the blog title or the
&#8216;continue reading...&#8217; link.</p>
<img alt="symblog homepage" class="align-center" src="../_images/homepage1.jpg" />
<p>While we can query for entities in the controller, it is not the best place to.
The querying would be better placed outside of the controller for a number of reasons:</p>
<blockquote>
<div><ol class="arabic simple">
<li>We would be unable to reuse the query elsewhere in the application, without
duplicating the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> code.</li>
<li>If we did duplicate the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> code, we would have to make multiple
modifications in the future if the query needed changing.</li>
<li>Separating the query and the controller would allow us to test the query
independently of the controller.</li>
</ol>
</div></blockquote>
<p>Doctrine 2 provides the Repository classes to facilitate this.</p>
</div>
</div>
</div>
<div class="section" id="doctrine-2-repositories">
<h2>Doctrine 2 Repositories<a class="headerlink" href="#doctrine-2-repositories" title="Permalink to this headline">¶</a></h2>
<p>We have already been introduced to the Doctrine 2 Repository classes in the previous
chapter when we created the blog show page. We used the default implementation of the
<tt class="docutils literal"><span class="pre">Doctrine\ORM\EntityRepository</span></tt> class to retrieve a blog entity from the
database via the <tt class="docutils literal"><span class="pre">find()</span></tt> method. As we want to create a custom query, we
need to create a custom repository. Doctrine 2 is able to assist in this task.
Update the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity metadata located in the file at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>
<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity(repositoryClass=&quot;Blogger\BlogBundle\Entity\Repository\BlogRepository&quot;)</span>
<span class="sd"> * @ORM\Table(name=&quot;blog&quot;)</span>
<span class="sd"> * @ORM\HasLifecycleCallbacks()</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Blog</span>
<span class="p">{</span>
    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can see we have specified the namespace location for the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> class
that this entity is associated with. As we have updated the Doctrine 2 metadata
for the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity, we need to re-run the <tt class="docutils literal"><span class="pre">doctrine:generate:entities</span></tt> task
as follows.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:generate:entities Blogger<span class="se">\B</span>logBundle
</pre></div>
</div>
<p>Doctrine 2 will have created the shell class for the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Repository/BlogRepository.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Entity/Repository/BlogRepository.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Entity\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * BlogRepository</span>
<span class="sd"> *</span>
<span class="sd"> * This class was generated by the Doctrine ORM. Add your own custom</span>
<span class="sd"> * repository methods below.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">BlogRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> class extends the  <tt class="docutils literal"><span class="pre">EntityRepository</span></tt>
class which provides the <tt class="docutils literal"><span class="pre">find()</span></tt> method we used earlier. Let&#8217;s update the
<tt class="docutils literal"><span class="pre">BlogRepository</span></tt> class, moving the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> code from the <tt class="docutils literal"><span class="pre">Page</span></tt>
controller into it.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Entity/Repository/BlogRepository.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Entity\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * BlogRepository</span>
<span class="sd"> *</span>
<span class="sd"> * This class was generated by the Doctrine ORM. Add your own custom</span>
<span class="sd"> * repository methods below.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">BlogRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLatestBlogs</span><span class="p">(</span><span class="nv">$limit</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">addOrderBy</span><span class="p">(</span><span class="s1">&#39;b.created&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$limit</span><span class="p">))</span>
            <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$limit</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
                  <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We have created the method <tt class="docutils literal"><span class="pre">getLatestBlogs</span></tt> which will return the
latest blog entries, much in the same way the controller <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> code did.
In the repository class we have direct access to the <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> via the
<tt class="docutils literal"><span class="pre">createQueryBuilder()</span></tt> method. We have also added a default <tt class="docutils literal"><span class="pre">$limit</span></tt> parameter
so we can limit the number of results to return. The result of the query
is much the same as it was in the controller. You may have noticed that we did not
need to specify the entity to use via the <tt class="docutils literal"><span class="pre">from()</span></tt> method. That&#8217;s because we
are within the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt> which is associated with the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity.
If we look at the implementation of the <tt class="docutils literal"><span class="pre">createQueryBuilder</span></tt> method in the
<tt class="docutils literal"><span class="pre">EntityRepository</span></tt> class we can see the <tt class="docutils literal"><span class="pre">from()</span></tt> method is called for us.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// Doctrine\ORM\EntityRepository</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createQueryBuilder</span><span class="p">(</span><span class="nv">$alias</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_em</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="nv">$alias</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_entityName</span><span class="p">,</span> <span class="nv">$alias</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally let&#8217;s update the <tt class="docutils literal"><span class="pre">Page</span></tt> controller <tt class="docutils literal"><span class="pre">index</span></tt> action to use the <tt class="docutils literal"><span class="pre">BlogRepository</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/PageController.php</span>
<span class="k">class</span> <span class="nc">PageController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
                   <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="nv">$blogs</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog&#39;</span><span class="p">)</span>
                    <span class="o">-&gt;</span><span class="na">getLatestBlogs</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Page:index.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;blogs&#39;</span> <span class="o">=&gt;</span> <span class="nv">$blogs</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now when you refresh the homepage it should display exactly the same as before.
All we have done is refactored our code so the correct classes are performing
the correct tasks.</p>
</div>
<div class="section" id="more-on-the-model-creating-the-comment-entity">
<h2>More on the Model: Creating the Comment Entity<a class="headerlink" href="#more-on-the-model-creating-the-comment-entity" title="Permalink to this headline">¶</a></h2>
<p>Blogs are only half the story when it comes to blogging. We also need to allow readers
the ability to comment on blog posts. These comments also need to be persisted, and linked
to the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity as a blog can contain many comments.</p>
<p>We will start by defining the basics of the <tt class="docutils literal"><span class="pre">Comment</span></tt> Entity class.
Create a new file located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Comment.php</span></tt> and
paste in the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Entity/Comment.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity(repositoryClass=&quot;Blogger\BlogBundle\Entity\Repository\CommentRepository&quot;)</span>
<span class="sd"> * @ORM\Table(name=&quot;comment&quot;)</span>
<span class="sd"> * @ORM\HasLifecycleCallbacks</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Comment</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$user</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;text&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$comment</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;boolean&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$approved</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\ManyToOne(targetEntity=&quot;Blog&quot;, inversedBy=&quot;comments&quot;)</span>
<span class="sd">     * @ORM\JoinColumn(name=&quot;blog_id&quot;, referencedColumnName=&quot;id&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$blog</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;datetime&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$created</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;datetime&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$updated</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setUpdated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setApproved</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\preUpdate</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUpdatedValue</span><span class="p">()</span>
    <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setUpdated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Most of what you see here, we have already covered in the previous chapter,
however we have used metadata to set up a link to the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity. As a
comment is for a blog, we have setup a link in the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity to
the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity it belongs to. We do this by specify a <tt class="docutils literal"><span class="pre">ManyToOne</span></tt> link targeting the
<tt class="docutils literal"><span class="pre">Blog</span></tt> entity. We also specify that the inverse of this link will be available
via <tt class="docutils literal"><span class="pre">comments</span></tt>. To create this inverse, we need to update the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity
so Doctrine 2 knows that a blog can contain many comments. Update the <tt class="docutils literal"><span class="pre">Blog</span></tt>
entity located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt> to add this mapping.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity(repositoryClass=&quot;Blogger\BlogBundle\Entity\Repository\BlogRepository&quot;)</span>
<span class="sd"> * @ORM\Table(name=&quot;blog&quot;)</span>
<span class="sd"> * @ORM\HasLifecycleCallbacks</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Blog</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\OneToMany(targetEntity=&quot;Comment&quot;, mappedBy=&quot;blog&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$comments</span><span class="p">;</span>

    <span class="c1">// ..</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setUpdated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are a few changes to point out here. First we add metadata to the <tt class="docutils literal"><span class="pre">$comments</span></tt>
member. Remember in the previous chapter we didn&#8217;t add any metadata for this member
because we didn&#8217;t want Doctrine 2 to persist it. This is still true, however, we
do want Doctrine 2 to be able to populate this member with the relevant <tt class="docutils literal"><span class="pre">Comment</span></tt>
entities. That is what the metadata achieves. Secondly, Doctrine 2 requires
that we default the <tt class="docutils literal"><span class="pre">$comments</span></tt> member to an <tt class="docutils literal"><span class="pre">ArrayCollection</span></tt> object.
We do this in the <tt class="docutils literal"><span class="pre">constructor</span></tt>. Also, note the <tt class="docutils literal"><span class="pre">use</span></tt> statement to import the
<tt class="docutils literal"><span class="pre">ArrayCollection</span></tt> class.</p>
<p>As we have now created the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity, and updated the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity,
let&#8217;s get Doctrine 2 to generate the accessors. Run the following Doctrine 2
task as before to achieve this.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:generate:entities Blogger<span class="se">\B</span>logBundle
</pre></div>
</div>
<p>Both entities should now be up-to-date with the correct accessor methods. You will
also notice the <tt class="docutils literal"><span class="pre">CommentRepository</span></tt> class has been created at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Repository/CommentRepository.php</span></tt> as we specified this in the
metadata.</p>
<p>Finally we need to update the database to reflect the changes to our entities. We
could use the <tt class="docutils literal"><span class="pre">doctrine:schema:update</span></tt> task as follows to do this, but instead
we will introduce Doctrine 2 Migrations.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:schema:update --force
</pre></div>
</div>
</div>
<div class="section" id="doctrine-2-migrations">
<h2>Doctrine 2 Migrations<a class="headerlink" href="#doctrine-2-migrations" title="Permalink to this headline">¶</a></h2>
<p>The Doctrine 2 Migrations extension and bundle do not come with the Symfony2 Standard
Distribution, we need to manually install them as we did with the Data Fixtures
extension and bundle. Open up the <tt class="docutils literal"><span class="pre">composer.json</span></tt> file located in the project root and add the
Doctrine 2 Migrations extension and bundle to it as follows.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="s2">&quot;require&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="s2">&quot;doctrine/doctrine-migrations-bundle&quot;</span><span class="o">:</span> <span class="s2">&quot;dev-master&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doctrine/migrations&quot;</span><span class="o">:</span> <span class="s2">&quot;dev-master&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next update the vendors to reflect these changes.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php composer.phar update
</pre></div>
</div>
<p>This will pull down the latest version of each of the repositories from GitHub and
install them to the required locations.</p>
<p>Now let&#8217;s register the bundle in the kernel located at <tt class="docutils literal"><span class="pre">app/AppKernel.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/AppKernel.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">registerBundles</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$bundles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// ...</span>
        <span class="k">new</span> <span class="nx">Doctrine\Bundle\MigrationsBundle\DoctrineMigrationsBundle</span><span class="p">(),</span>
        <span class="c1">// ...</span>
    <span class="p">);</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We are now ready to update the database to reflect the entity changes. This
is a 2 step process. First we need to get Doctrine 2 Migrations to work out the differences
between the entities and the current database schema. This is done with the
<tt class="docutils literal"><span class="pre">doctrine:migrations:diff</span></tt> task. Secondly we need to actually perform the migration
based on the previously created diff. This is done with the
<tt class="docutils literal"><span class="pre">doctrine:migrations:migrate</span></tt> task.</p>
<p>Run the following 2 commands to update the database schema.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:migrations:diff
<span class="nv">$ </span>php app/console doctrine:migrations:migrate
</pre></div>
</div>
<p>Your database will now reflect the latest entity changes and contain the new
comment table.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You will also notice a new table in the database called <tt class="docutils literal"><span class="pre">migration_versions</span></tt>.
This stores the migration version numbers so the migration task is able to
see what the current version of the database is.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Doctrine 2 Migrations are a great way to update the production database as
the changes can be done programatically. This means we can integrate this
task into a deployment script so the database is updated automatically when
we deploy a new release of the application. Doctrine 2 Migrations also allow
us to roll back the changes as every created Migration has a <tt class="docutils literal"><span class="pre">up</span></tt> and <tt class="docutils literal"><span class="pre">down</span></tt>
method. To roll back to a previous version you need to specify the version number
you would like to roll back to using the following task.</p>
<div class="last highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:migrations:migrate 20110806183439
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-fixtures-revisited">
<h2>Data Fixtures: Revisited<a class="headerlink" href="#data-fixtures-revisited" title="Permalink to this headline">¶</a></h2>
<p>Now we have the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity created, let&#8217;s add some fixtures for it.
It is always a good idea to add some fixtures each time you create an entity.
We know that a comment must have a related <tt class="docutils literal"><span class="pre">Blog</span></tt> entity set as it is setup
this way in the metadata, therefore when creating fixtures for <tt class="docutils literal"><span class="pre">Comment</span></tt> entities
we will need to specify the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity. We have already created the fixtures
for the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity so we could simply update this file to add the <tt class="docutils literal"><span class="pre">Comment</span></tt>
entities. This may be manageable for now, but what happens when we later add users,
blog categories, and a whole load of other entities to our bundle? A better way
would be to create a new file for the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity fixtures. The problem
with this approach is how do we access the <tt class="docutils literal"><span class="pre">Blog</span></tt> entities from the blog
fixtures.</p>
<p>Fortunately this can be achieved easily by setting references to objects in one
fixture file that other fixtures can access. Update the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity
<tt class="docutils literal"><span class="pre">DataFixtures</span></tt> located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/DataFixtures/ORM/BlogFixtures.php</span></tt> with the following.
The changes to note here are the extension of the <tt class="docutils literal"><span class="pre">AbstractFixture</span></tt> class and
the implementation of the <tt class="docutils literal"><span class="pre">OrderedFixtureInterface</span></tt>. Also note the 2 new use
statements to import these classes.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/DataFixtures/ORM/BlogFixtures.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\DataFixtures\ORM</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\Common\DataFixtures\AbstractFixture</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\DataFixtures\OrderedFixtureInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Persistence\ObjectManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Entity\Blog</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BlogFixtures</span> <span class="k">extends</span> <span class="nx">AbstractFixture</span> <span class="k">implements</span> <span class="nx">OrderedFixtureInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">load</span><span class="p">(</span><span class="nx">ObjectManager</span> <span class="nv">$manager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>

        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addReference</span><span class="p">(</span><span class="s1">&#39;blog-1&#39;</span><span class="p">,</span> <span class="nv">$blog1</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">,</span> <span class="nv">$blog2</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addReference</span><span class="p">(</span><span class="s1">&#39;blog-3&#39;</span><span class="p">,</span> <span class="nv">$blog3</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addReference</span><span class="p">(</span><span class="s1">&#39;blog-4&#39;</span><span class="p">,</span> <span class="nv">$blog4</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addReference</span><span class="p">(</span><span class="s1">&#39;blog-5&#39;</span><span class="p">,</span> <span class="nv">$blog5</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOrder</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We add references to the blog entities using the <tt class="docutils literal"><span class="pre">addReference()</span></tt> method.
This first parameter is a reference identifier we can use the retrieve the object
later. Finally we must implement the <tt class="docutils literal"><span class="pre">getOrder()</span></tt> method to specify the loading order
of the fixtures. Blogs must be loaded before comments so we return 1.</p>
<div class="section" id="comment-fixtures">
<h3>Comment Fixtures<a class="headerlink" href="#comment-fixtures" title="Permalink to this headline">¶</a></h3>
<p>We are now ready to define some fixtures for our <tt class="docutils literal"><span class="pre">Comment</span></tt> entity. Create a fixtures file
at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/DataFixtures/ORM/CommentFixtures.php</span></tt> and add the
following content:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/DataFixtures/ORM/CommentFixtures.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\DataFixtures\ORM</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\Common\DataFixtures\AbstractFixture</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\DataFixtures\OrderedFixtureInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Persistence\ObjectManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Entity\Comment</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Entity\Blog</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CommentFixtures</span> <span class="k">extends</span> <span class="nx">AbstractFixture</span> <span class="k">implements</span> <span class="nx">OrderedFixtureInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">load</span><span class="p">(</span><span class="nx">ObjectManager</span> <span class="nv">$manager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;symfony&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;To make a long story short. You can\&#39;t go wrong by choosing Symfony! And no one has ever been fired for using Symfony.&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-1&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;David&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;To make a long story short. Choosing a framework must not be taken lightly; it is a long-term commitment. Make sure that you make the right selection!&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-1&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Dade&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Anything else, mom? You want me to mow the lawn? Oops! I forgot, New York, No grass.&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Kate&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Are you challenging me? &#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 06:15:20&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Dade&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Name your stakes.&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 06:18:35&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Kate&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;If I win, you become my slave.&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 06:22:53&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Dade&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Your SLAVE?&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 06:25:15&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Kate&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;You wish! You\&#39;ll do shitwork, scan, crack copyrights...&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 06:46:08&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Dade&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;And if I win?&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 10:22:46&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Kate&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Make it my first-born!&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-23 11:08:08&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Dade&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Make it our first-date!&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-24 18:56:01&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Kate&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;I don\&#39;t DO dates. But I don\&#39;t lose either, so you\&#39;re on!&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;2011-07-25 22:28:42&quot;</span><span class="p">));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Stanley&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;It\&#39;s not gonna end like this.&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-3&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Gabriel&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Oh, come on, Stan. Not everything ends the way you think it should. Besides, audiences love happy endings.&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-3&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Mile&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Doesn\&#39;t Bill Gates have something like that?&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-5&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="s1">&#39;Gary&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setComment</span><span class="p">(</span><span class="s1">&#39;Bill Who?&#39;</span><span class="p">);</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-5&#39;</span><span class="p">)));</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOrder</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As with the modifications we made the <tt class="docutils literal"><span class="pre">BlogFixtures</span></tt> class, the <tt class="docutils literal"><span class="pre">CommentFixtures</span></tt>
class also extends the <tt class="docutils literal"><span class="pre">AbstractFixture</span></tt> class and  implements the <tt class="docutils literal"><span class="pre">OrderedFixtureInterface</span></tt>.
This means we must also implement the <tt class="docutils literal"><span class="pre">getOrder()</span></tt> method. This time we set the
return value to 2, ensuring these fixtures will be loaded after the blog fixtures.</p>
<p>We can also see how the references to the <tt class="docutils literal"><span class="pre">Blog</span></tt> entities we created earlier
are being used.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="s1">&#39;blog-2&#39;</span><span class="p">)));</span>
</pre></div>
</div>
<p>We are now ready to load the fixtures into the database.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:fixtures:load
</pre></div>
</div>
</div>
</div>
<div class="section" id="displaying-comments">
<h2>Displaying Comments<a class="headerlink" href="#displaying-comments" title="Permalink to this headline">¶</a></h2>
<p>We can now display the comments related to each blog post. We begin by
updating the <tt class="docutils literal"><span class="pre">CommentRepository</span></tt> with a method to retrieve the latest approved
comments for a blog post.</p>
<div class="section" id="comment-repository">
<h3>Comment Repository<a class="headerlink" href="#comment-repository" title="Permalink to this headline">¶</a></h3>
<p>Open the <tt class="docutils literal"><span class="pre">CommentRepository</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Repository/CommentRepository.php</span></tt> and replace its
content with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Entity/Repository/CommentRepository.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Entity\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * CommentRepository</span>
<span class="sd"> *</span>
<span class="sd"> * This class was generated by the Doctrine ORM. Add your own custom</span>
<span class="sd"> * repository methods below.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">CommentRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCommentsForBlog</span><span class="p">(</span><span class="nv">$blogId</span><span class="p">,</span> <span class="nv">$approved</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;c.blog = :blog_id&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">addOrderBy</span><span class="p">(</span><span class="s1">&#39;c.created&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;blog_id&#39;</span><span class="p">,</span> <span class="nv">$blogId</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$approved</span><span class="p">))</span>
            <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;c.approved = :approved&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;approved&#39;</span><span class="p">,</span> <span class="nv">$approved</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
                  <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The method we have created will retrieve comments for a blog post. To do this
we need to add a where clause to our query. The where clause uses a named parameter
that is set using the <tt class="docutils literal"><span class="pre">setParameter()</span></tt> method. You should always use parameters
instead of setting the values directly in the query like so</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;c.blog = &#39;</span> <span class="o">.</span> <span class="nx">blogId</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example the value of <tt class="docutils literal"><span class="pre">$blogId</span></tt> will not be sanitized and could leave the
query open to an <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection</a> attack.</p>
</div>
</div>
<div class="section" id="blog-controller">
<h2>Blog Controller<a class="headerlink" href="#blog-controller" title="Permalink to this headline">¶</a></h2>
<p>Next we need to update the <tt class="docutils literal"><span class="pre">show</span></tt> action of the <tt class="docutils literal"><span class="pre">Blog</span></tt> controller to retrieve
the comments for the blog. Update the <tt class="docutils literal"><span class="pre">Blog</span></tt> controller located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/BlogController.php</span></tt> with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Controller/BlogController.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$blog</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span><span class="s1">&#39;Unable to find Blog post.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$comments</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Comment&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">getCommentsForBlog</span><span class="p">(</span><span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog:show.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;blog&#39;</span>      <span class="o">=&gt;</span> <span class="nv">$blog</span><span class="p">,</span>
        <span class="s1">&#39;comments&#39;</span>  <span class="o">=&gt;</span> <span class="nv">$comments</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We use the new method on the <tt class="docutils literal"><span class="pre">CommentRepository</span></tt> to retrieve the approved comments
for the blog. The <tt class="docutils literal"><span class="pre">$comments</span></tt> collection is also passed into the template.</p>
<div class="section" id="blog-show-template">
<h3>Blog show template<a class="headerlink" href="#blog-show-template" title="Permalink to this headline">¶</a></h3>
<p>Now we have a list of comments for the blog we can update the blog show template
to display the comments. We could simply place the rendering of the comments
directly in the blog show template, but as comments are their own entity, it would
be better to separate the rendering into another template, and include that
template. This would allow us to reuse the comment rendering template elsewhere in the
application. Update the blog show template located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig</span></tt> with the
following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig #}

{# .. #}

{% block body %}
    {# .. #}

    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span> <span class="na">id=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;previous-comments&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h3&gt;</span>Comments<span class="nt">&lt;/h3&gt;</span>
            {% include &#39;BloggerBlogBundle:Comment:index.html.twig&#39; with { &#39;comments&#39;: comments } %}
        <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
{% endblock %}
</pre></div>
</div>
<p>You can see the use of a new Twig tag, the <tt class="docutils literal"><span class="pre">include</span></tt> tag. This will include the
content of the template specified by <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Comment:index.html.twig</span></tt>.
We can also pass over any number of arguments to the template. In this case, we need
to pass over a collection of <tt class="docutils literal"><span class="pre">Comment</span></tt> entities to render.</p>
</div>
<div class="section" id="comment-show-template">
<h3>Comment show template<a class="headerlink" href="#comment-show-template" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Comment:index.html.twig</span></tt> we are including above does
not exist yet so we need to create it. As this is just a template, we don&#8217;t need
to create a route or a controller for this, we only need the template file. Create
a new file located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Comment/index.html.twig</span></tt>
and paste in the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Comment/index.html.twig #}

{% for comment in comments %}
    <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;comment {{ cycle([&#39;odd&#39;, &#39;even&#39;], loop.index0) }}&quot;</span> <span class="na">id=</span><span class="s">&quot;comment-{{ comment.id }}&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;header&gt;</span>
            <span class="nt">&lt;p&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;highlight&quot;</span><span class="nt">&gt;</span>{{ comment.user }}<span class="nt">&lt;/span&gt;</span> commented <span class="nt">&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;{{ comment.created|date(&#39;c&#39;) }}&quot;</span><span class="nt">&gt;</span>{{ comment.created|date(&#39;l, F j, Y&#39;) }}<span class="nt">&lt;/time&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/header&gt;</span>
        <span class="nt">&lt;p&gt;</span>{{ comment.comment }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/article&gt;</span>
{% else %}
    <span class="nt">&lt;p&gt;</span>There are no comments for this post. Be the first to comment...<span class="nt">&lt;/p&gt;</span>
{% endfor %}
</pre></div>
</div>
<p>As you can see we iterate over a collection of <tt class="docutils literal"><span class="pre">Comment</span></tt> entities and display
the comments. We also introduce one of the other nice Twig functions, the <tt class="docutils literal"><span class="pre">cycle</span></tt>
function. This function will cycle through the values in the array you
pass it as each iteration of the loop progresses. The current loop iteration value
is obtained via the special <tt class="docutils literal"><span class="pre">loop.index0</span></tt> variable. This keeps a count of the
loop iterations, starting at 0. There are a number of other
<a class="reference external" href="http://www.twig-project.org/doc/templates.html#for">special variables</a>
available when we are within a loop code block. You may also notice the setting
of an HTML ID to the <tt class="docutils literal"><span class="pre">article</span></tt> element. This will allow us to later create
permalinks to created comments.</p>
</div>
<div class="section" id="comment-show-css">
<h3>Comment show CSS<a class="headerlink" href="#comment-show-css" title="Permalink to this headline">¶</a></h3>
<p>Finally let&#8217;s add some CSS to keep the comments looking stylish. Update the stylesheet
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resorces/public/css/blog.css</span></tt> with the following.</p>
<div class="highlight-css"><div class="highlight"><pre><span class="c">/** src/Blogger/BlogBundle/Resorces/public/css/blog.css **/</span>
<span class="nc">.comments</span> <span class="p">{</span> <span class="k">clear</span><span class="o">:</span> <span class="k">both</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.comments</span> <span class="nc">.odd</span> <span class="p">{</span> <span class="k">background</span><span class="o">:</span> <span class="m">#eee</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.comments</span> <span class="nc">.comment</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.comments</span> <span class="nc">.comment</span> <span class="nt">p</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.comments</span> <span class="nt">h3</span> <span class="p">{</span> <span class="k">background</span><span class="o">:</span> <span class="m">#eee</span><span class="p">;</span> <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="k">clear</span><span class="o">:</span> <span class="k">both</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.comments</span> <span class="nc">.previous-comments</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you are not using the symlink method for referencing bundle assets into the
<tt class="docutils literal"><span class="pre">web</span></tt> folder you must re-run the assets install task now to copy over the
changes to your CSS.</p>
<div class="last highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console assets:install web
</pre></div>
</div>
</div>
<p>If you now have a look at one of the blog show pages, e.g.
<tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/2</span></tt> you should see the blog comments output.</p>
<img alt="symblog show blog comments" class="align-center" src="../_images/comments.jpg" />
</div>
</div>
<div class="section" id="adding-comments">
<h2>Adding Comments<a class="headerlink" href="#adding-comments" title="Permalink to this headline">¶</a></h2>
<p>The last part of this chapter will add the functionality for users to add
comments to a blog post. This will be possible via a form on the blog show page. We
have already been introduced to creating forms in Symfony2 when we created the
contact form. Rather than creating the comment form manually, we can use Symfony2
to do this for us. Run the following task to generate the <tt class="docutils literal"><span class="pre">CommentType</span></tt> class for
the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console generate:doctrine:form BloggerBlogBundle:Comment
</pre></div>
</div>
<p>You&#8217;ll notice again here, the use of the short hand version to specify the
<tt class="docutils literal"><span class="pre">Comment</span></tt> entity.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You may have noticed the task <tt class="docutils literal"><span class="pre">doctrine:generate:form</span></tt> is also available.
This is the same task just namespaced differently.</p>
</div>
<p>The generate form task has created the <tt class="docutils literal"><span class="pre">CommentType</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Form/CommentType.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Form/CommentType.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Form</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CommentType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilder</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;approved&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;blog&#39;</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;blogger_blogbundle_commenttype&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We have already explored what is happening here in the previous <tt class="docutils literal"><span class="pre">EnquiryType</span></tt>
class. We could begin by customising this class now, but let&#8217;s move onto displaying
the form first.</p>
<div class="section" id="displaying-the-comment-form">
<h3>Displaying the Comment Form<a class="headerlink" href="#displaying-the-comment-form" title="Permalink to this headline">¶</a></h3>
<p>As we want the user to add comments from the show blog page, we could create the
form in the <tt class="docutils literal"><span class="pre">show</span></tt> action of the <tt class="docutils literal"><span class="pre">Blog</span></tt> controller and render the form
directly in the <tt class="docutils literal"><span class="pre">show</span></tt> template. However, it would be better to separate this
code as we did with displaying the comments. The difference between showing
the comments and displaying the comment form is the comment form needs
processing, so this time a controller is required. This introduces a method
slightly different to the above where we just included a template.</p>
</div>
<div class="section" id="routing">
<h3>Routing<a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h3>
<p>We need to create a new route to handle the processing of submitted forms. Add
a new route to  the routing file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/config/routing.yml</span></tt>.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">BloggerBlogBundle_comment_create</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/comment/{blog_id}</span>
    <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">BloggerBlogBundle</span><span class="p-Indicator">:</span><span class="nv">Comment</span><span class="p-Indicator">:</span><span class="nv">create</span> <span class="p-Indicator">}</span>
    <span class="l-Scalar-Plain">requirements</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">_method</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">POST</span>
        <span class="l-Scalar-Plain">blog_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">\d+</span>
</pre></div>
</div>
</div>
<div class="section" id="the-controller">
<h3>The controller<a class="headerlink" href="#the-controller" title="Permalink to this headline">¶</a></h3>
<p>Next, we need to create the new <tt class="docutils literal"><span class="pre">Comment</span></tt> controller we have referenced above.
Create a file located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Controller/CommentController.php</span></tt> and
paste in the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Controller/CommentController.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Entity\Comment</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Form\CommentType</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Comment controller.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">CommentController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">newAction</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getBlog</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">);</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$blog</span><span class="p">);</span>
        <span class="nv">$form</span>   <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">CommentType</span><span class="p">(),</span> <span class="nv">$comment</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Comment:form.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;comment&#39;</span> <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span>   <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">()</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getBlog</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">);</span>

        <span class="nv">$comment</span>  <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">();</span>
        <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">setBlog</span><span class="p">(</span><span class="nv">$blog</span><span class="p">);</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
        <span class="nv">$form</span>    <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">CommentType</span><span class="p">(),</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">bindRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// TODO: Persist the comment entity</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle_blog_show&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getBlog</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()))</span> <span class="o">.</span>
                <span class="s1">&#39;#comment-&#39;</span> <span class="o">.</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Comment:create.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;comment&#39;</span> <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">()</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getBlog</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
                    <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$blog</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span><span class="s1">&#39;Unable to find Blog post.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$blog</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>We create 2 actions in the <tt class="docutils literal"><span class="pre">Comment</span></tt> controller, one for <tt class="docutils literal"><span class="pre">new</span></tt> and one for
<tt class="docutils literal"><span class="pre">create</span></tt>. The <tt class="docutils literal"><span class="pre">new</span></tt> action is concerned with displaying the comment form,
the <tt class="docutils literal"><span class="pre">create</span></tt> action is concerned with processing the submission of the comment
form. While this may seem like a big chuck of code, there is nothing new here,
everything was covered in chapter 2 when we created the contact form. However,
before moving on make sure you fully understand what is happening in the
<tt class="docutils literal"><span class="pre">Comment</span></tt> controller.</p>
</div>
<div class="section" id="form-validation">
<h3>Form Validation<a class="headerlink" href="#form-validation" title="Permalink to this headline">¶</a></h3>
<p>We don&#8217;t want users to be able to submit blog comments with blank <tt class="docutils literal"><span class="pre">user</span></tt> or
<tt class="docutils literal"><span class="pre">comment</span></tt> values. To achieve this we look back to the validators we were
introduced to in part 2 when creating the enquiry form. Update the <tt class="docutils literal"><span class="pre">Comment</span></tt>
entity located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Comment.php</span></tt> with the
following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Entity/Comment.php</span>

<span class="c1">// ..</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Mapping\ClassMetadata</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints\NotBlank</span><span class="p">;</span>

<span class="c1">// ..</span>
<span class="k">class</span> <span class="nc">Comment</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">loadValidatorMetadata</span><span class="p">(</span><span class="nx">ClassMetadata</span> <span class="nv">$metadata</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$metadata</span><span class="o">-&gt;</span><span class="na">addPropertyConstraint</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">NotBlank</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;You must enter your name&#39;</span>
        <span class="p">)));</span>
        <span class="nv">$metadata</span><span class="o">-&gt;</span><span class="na">addPropertyConstraint</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">NotBlank</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;You must enter a comment&#39;</span>
        <span class="p">)));</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The constraints ensure that both the user and comment members must not be blank.
We have also set the <tt class="docutils literal"><span class="pre">message</span></tt> option for both constraints to override the
default ones. Remember to add the namespace for <tt class="docutils literal"><span class="pre">ClassMetadata</span></tt> and
<tt class="docutils literal"><span class="pre">NotBlank</span></tt> as shown above.</p>
</div>
<div class="section" id="id1">
<h3>The view<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Next we need to create the 2 templates for the <tt class="docutils literal"><span class="pre">new</span></tt> and <tt class="docutils literal"><span class="pre">create</span></tt> controller
actions. First create  a new file
located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Comment/form.html.twig</span></tt>
and paste in the following.</p>
<div class="highlight-html"><pre>{# src/Blogger/BlogBundle/Resources/views/Comment/form.html.twig #}

&lt;form action="{{ path('BloggerBlogBundle_comment_create', { 'blog_id' : comment.blog.id } ) }}" method="post" {{ form_enctype(form) }} class="blogger"&gt;
    {{ form_widget(form) }}
    &lt;p&gt;
        &lt;input type="submit" value="Submit"&gt;
    &lt;/p&gt;
&lt;/form&gt;</pre>
</div>
<p>The purpose of this template is simple, it just renders the comment form. You&#8217;ll
also notice the <tt class="docutils literal"><span class="pre">action</span></tt> of the form is to <tt class="docutils literal"><span class="pre">POST</span></tt> to the new route we created
<tt class="docutils literal"><span class="pre">BloggerBlogBundle_comment_create</span></tt>.</p>
<p>Next let&#8217;s add the template for the <tt class="docutils literal"><span class="pre">create</span></tt> view. Create a new file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Comment/create.html.twig</span></tt>
and paste in the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{% extends &#39;BloggerBlogBundle::layout.html.twig&#39; %}

{% block title %}Add Comment{% endblock%}

{% block body %}
    <span class="nt">&lt;h1&gt;</span>Add comment for blog post &quot;{{ comment.blog.title }}&quot;<span class="nt">&lt;/h1&gt;</span>
    {% include &#39;BloggerBlogBundle:Comment:form.html.twig&#39; with { &#39;form&#39;: form } %}
{% endblock %}
</pre></div>
</div>
<p>As the <tt class="docutils literal"><span class="pre">create</span></tt> action of the <tt class="docutils literal"><span class="pre">Comment</span></tt> controller deals with processing
the form, it also needs to be able to display it, as there could be errors in the
form. We reuse the <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Comment:form.html.twig</span></tt> to render the
actual form to prevent code duplication.</p>
<p>Now let&#8217;s update the blog show template to render the add blog form. Update the
template located at <tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig</span></tt>
with the following.</p>
<div class="highlight-html"><div class="highlight"><pre>{# src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig #}

{# .. #}

{% block body %}

    {# .. #}

    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span> <span class="na">id=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span>
        {# .. #}

        <span class="nt">&lt;h3&gt;</span>Add Comment<span class="nt">&lt;/h3&gt;</span>
        {{ render(controller(&#39;BloggerBlogBundle:Comment:new&#39;, { &#39;blog_id&#39;: blog.id } )) }}
    <span class="nt">&lt;/section&gt;</span>
{% endblock %}
</pre></div>
</div>
<p>We use another new Twig tag here, the <tt class="docutils literal"><span class="pre">render</span></tt> tag. This tag will render
the contents of a controller into the template. In our case we render the
contents of the <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Comment:new</span></tt> controller action.</p>
<p>If you now have a look at one of the blog show pages, such as
<tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/2</span></tt> you&#8217;ll notice a Symfony2 exception is thrown.</p>
<img alt="toString() Symfony2 Exception" class="align-center" src="../_images/to_string_error.jpg" />
<p>This exception is being thrown by the <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Blog:show.html.twig</span></tt>
template. If we look at line 25 of the <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Blog:show.html.twig</span></tt>
template we can see it&#8217;s the following line showing that the problem actually exists
in the process of embedding the <tt class="docutils literal"><span class="pre">BloggerBlogBundle:Comment:create</span></tt> controller.</p>
<div class="highlight-html"><div class="highlight"><pre>{% render &#39;BloggerBlogBundle:Comment:create&#39; with { &#39;blog_id&#39;: blog.id } %}
</pre></div>
</div>
<p>If we look at the exception message further it gives us some more information
about the nature of why the exception was caused.</p>
<blockquote>
<div>Entities passed to the choice field must have a &#8220;__toString()&#8221; method defined</div></blockquote>
<p>This is telling us that a choice field that we are trying to render doesn&#8217;t have
a <tt class="docutils literal"><span class="pre">__toString()</span></tt> method set for the entity the choice field is associated with.
A choice field is a form element that gives the user a number of choices,
such as a <tt class="docutils literal"><span class="pre">select</span></tt> (drop down) element. You may be wondering where are we rendering
a choice field in the comment form? If you look at the comment form template again you will notice
we render the form using the <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">form_widget(form)</span> <span class="pre">}}</span></tt> Twig function. This
function outputs the entire form in its basic form. So let&#8217;s go back to the class
the form is created from, the <tt class="docutils literal"><span class="pre">CommentType</span></tt> class. We can see that a number of
fields are being added to the form via the <tt class="docutils literal"><span class="pre">FormBuilder</span></tt> object. In particular
we are adding a <tt class="docutils literal"><span class="pre">blog</span></tt> field.</p>
<p>If you remember from chapter 2, we spoke about how the <tt class="docutils literal"><span class="pre">FormBuilder</span></tt> will try
to guess the field type to output based on metadata related to the field. As we
setup a relationship between <tt class="docutils literal"><span class="pre">Comment</span></tt> and <tt class="docutils literal"><span class="pre">Blog</span></tt> entities, the
<tt class="docutils literal"><span class="pre">FormBuilder</span></tt> has guessed the comment should be a <tt class="docutils literal"><span class="pre">choice</span></tt> field, which
would allow the user to specify the blog post to attach the comment to. That is
why we have a <tt class="docutils literal"><span class="pre">choice</span></tt> field in the form, and why the Symfony2 exception is
being thrown. We can fix this problem by implementing the <tt class="docutils literal"><span class="pre">__toString()</span></tt>
method in the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Entity/Blog.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">__toString</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTitle</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The Symfony2 error messages are very informative when describing the problem
that has occurred. Always read the error messages as they will usually make
the debugging process a lot easier. The error messages also provide a full
stack trace so you can see the steps that were taken to cause the error.</p>
</div>
<p>Now when you refresh the page you should see the comment form output. You will
also notice that some undesirable fields have been output such as <tt class="docutils literal"><span class="pre">approved</span></tt>,
<tt class="docutils literal"><span class="pre">created</span></tt>, <tt class="docutils literal"><span class="pre">updated</span></tt> and <tt class="docutils literal"><span class="pre">blog</span></tt>. This is because we did not customise
the generated <tt class="docutils literal"><span class="pre">CommentType</span></tt> class earlier.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The fields being rendered all seem to be output as the correct type of fields.
The <tt class="docutils literal"><span class="pre">user</span></tt> fields is an <tt class="docutils literal"><span class="pre">text</span></tt> field, the <tt class="docutils literal"><span class="pre">comment</span></tt> field is a <tt class="docutils literal"><span class="pre">textarea</span></tt>,
the 2 <tt class="docutils literal"><span class="pre">DateTime</span></tt> fields are a number of <tt class="docutils literal"><span class="pre">select</span></tt> fields allowing us to specify the
time, etc.</p>
<p class="last">This is because of the ability of <tt class="docutils literal"><span class="pre">FormBuilder</span></tt> to guess the type of field
the member it is rendering requires. It is able to do this based on the metadata
you provide. As we have specified quite specific metadata for the <tt class="docutils literal"><span class="pre">Comment</span></tt>
entity, the <tt class="docutils literal"><span class="pre">FormBuilder</span></tt> is able to make accurate guesses of the field types.</p>
</div>
<p>Let&#8217;s now update this class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Form/CommentType.php</span></tt> to output only the fields we
need.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Form/CommentType.php</span>

<span class="c1">// ..</span>
<span class="k">class</span> <span class="nc">CommentType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilder</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now when you refresh the page only the user and comment fields are output. If
you were to submit the form now, the comment would not actually be saved to the
database. That&#8217;s because the form controller does nothing with the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity
if the form passes validation. So how do we persist the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity to the database?
You have already seen how to do this when creating <tt class="docutils literal"><span class="pre">DataFixtures</span></tt>. Update the
<tt class="docutils literal"><span class="pre">create</span></tt> action of the <tt class="docutils literal"><span class="pre">Comment</span></tt> controller to persist the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity
to the database.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Controller/CommentController.php</span>

<span class="c1">// ..</span>
<span class="k">class</span> <span class="nc">CommentController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
                       <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
            <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>
            <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle_blog_show&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getBlog</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()))</span> <span class="o">.</span>
                <span class="s1">&#39;#comment-&#39;</span> <span class="o">.</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ..</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Persisting the <tt class="docutils literal"><span class="pre">Comment</span></tt> entity is as simple as a call to <tt class="docutils literal"><span class="pre">persist()</span></tt> and <tt class="docutils literal"><span class="pre">flush()</span></tt>.
Remember, the form just deals with PHP objects, and Doctrine 2 manages and persists
these objects. There is no direct connection between submitting a form, and
the submitted data being persisted to the database.</p>
<p>You should now be able to add comments to the blog posts.</p>
<img alt="symblog add blog comments" class="align-center" src="../_images/add_comments.jpg" />
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>We have made good progress in this chapter. Our blogging website is starting to
function more like you&#8217;d expect. We now have the basics of the homepage created
and the comment entity. Users can now post comments on blogs and read comments
left by other user. We saw how to create fixtures that could be referenced
across multiple fixture files and used Doctrine 2 Migrations to keep the database
schema inline with the entity changes.</p>
<p>Next we will look at building the sidebar to include The Tag Cloud and Recent
Comments. We will also extend Twig by creating our own custom filters. Finally
we will look at using the Assetic asset library to assist us in managing our
assets.</p>
</div>
</div>



    <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="doctrine-2-the-blog-model.html">[Part 3] - The Blog Model: Using Doctrine 2 and Data Fixtures</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="customising-the-view-more-with-twig.html">[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic</a>&#160;&#160;»
        </p>

    </div>

    <div id="disqus_thread"></div>

    <script type="text/javascript">
        var disqus_shortname = 'symblogtutorial';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
  <div class="bottomnav">
  
        <p>
        «&#160;&#160;<a href="doctrine-2-the-blog-model.html">[Part 3] - The Blog Model: Using Doctrine 2 and Data Fixtures</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="customising-the-view-more-with-twig.html">[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic</a>&#160;&#160;»
        </p>

  </div>

    <div class="footer">
        &copy; Copyright 2011, dsyph3r.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>